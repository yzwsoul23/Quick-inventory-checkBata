<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ—è¡¨ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f4f4f4;
        }

        #dataList {
            width: 95%;
            max-width: 800px;
            margin: 5px auto;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: calc(100vh - 200px);
            overflow-y: auto;
            will-change: transform; /* æç¤ºæµè§ˆå™¨å…ƒç´ ä¼šé¢‘ç¹å˜åŒ– */
            -webkit-overflow-scrolling: touch; /* æé«˜ç§»åŠ¨ç«¯æ»šåŠ¨æ€§èƒ½ */
        }

        /* æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: #007bff;
            font-weight: bold;
        }

        /* æ·»åŠ åˆ†é¡µæ§åˆ¶æ ·å¼ */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .pagination-buttons {
            display: flex;
            gap: 10px;
        }
        
        .pagination-buttons button {
            padding: 5px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination-buttons button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .pagination-buttons button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        
        .paginated-items {
            margin-top: 10px;
        }

        .list-item {
            padding: 8px;
            border-bottom: 1.5px solid #f0f0f0;
            display: flex;
            align-items: center;
            font-size: 14px;
            flex-wrap: nowrap;
            justify-content: space-between;
            gap: 8px;
            transition: transform 0.3s, background-color 0.3s;
            touch-action: pan-y;
            user-select: none;
            cursor: default;
            will-change: transform; /* æç¤ºæµè§ˆå™¨å…ƒç´ ä¼šé¢‘ç¹å˜åŒ– */
            contain: layout; /* å‘Šè¯‰æµè§ˆå™¨æ­¤å…ƒç´ å¸ƒå±€ç‹¬ç«‹ */
        }

        .list-item:nth-child(even) {
            background-color: #f8f9fa;
        }

        .list-item:nth-child(odd) {
            background-color: white;
        }

        .list-item.location-item {
            background-color: #fff3cd;
            color: #dc3545;
            font-weight: bold;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background-color: #f0f0f0;
        }

        .input-container {
            width: 95%;
            max-width: 800px;
            margin: 5px auto;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #itemInput {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            width: max-content;
            min-width: 200px;
            max-width: 100%;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .button-container {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .action-btn {
            margin-left: 0;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 12px;
            color: white;
            white-space: nowrap;
        }

        .edit-btn {
            background-color: #28a745;
        }

        .edit-btn:hover {
            background-color: #218838;
        }

        .delete-btn {
            background-color: #dc3545;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        #exportButton, #batchAddButton, #batchEditButton, #deleteAllButton {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-size: 14px;
            transition: background-color 0.3s;
            flex: 1 1 calc(50% - 4px);
            min-width: calc(50% - 4px);
            margin: 0;
        }

        #editModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #editModal input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #editModal button {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #editModal button:hover {
            background-color: #0056b3;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        #editAllModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #editAllModal textarea {
            width: 100%;
            height: 400px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 4px;
            margin-bottom: 10px;
            resize: vertical;
        }

        #editAllModal button {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #importModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #importModal textarea {
            width: 100%;
            height: 400px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 4px;
            margin-bottom: 10px;
            resize: vertical;
        }

        #importModal button {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #exportButton {
            background-color: #007bff;
        }

        #collapseAllButton {
            position: fixed;
            right: 20px;
            bottom: 70px;
            width: 40px;
            height: 40px;
            background-color: rgba(108, 117, 125, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 999;
        }

        #collapseAllButton:hover {
            background-color: rgba(108, 117, 125, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #batchAddButton {
            background-color: #28a745;
        }

        #batchEditButton {
            background-color: #17a2b8;
        }

        #deleteAllButton {
            background-color: #dc3545;
        }

        #importModal button:hover {
            background-color: #0056b3;
        }

        #guideModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #guideModal .guide-content {
            white-space: pre-line;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        #guideModal button {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #guideModal button:hover {
            background-color: #0056b3;
        }

        .item-text {
            flex: 1;
            min-width: 0;
            word-break: break-all;
        }

        /* æ·»åŠ æŠ˜å /å±•å¼€å›¾æ ‡çš„æ ·å¼ */
        .collapse-icon {
            display: inline-block;
            margin-right: 0px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.3s;
        }

        /* åœ°ç‚¹è¡Œçš„é¼ æ ‡æ ·å¼ */
        .location-item {
            cursor: pointer;
        }

        /* åœ°ç‚¹è¡Œhoveræ•ˆæœ */
        .location-item:hover {
            background-color: #fff3cd;
        }

        /* èµ„äº§è¡Œçš„æ ·å¼ */
        .asset-item {
            transition: all 0.3s ease;
        }

        /* æŒ‰é’®ä¸ç»§æ‰¿çˆ¶å…ƒç´ çš„cursor */
        .action-btn {
            cursor: pointer;
        }

        .button-container {
            cursor: default;
        }

        #searchModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #searchInput {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #searchResults {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .search-result-location {
            color: #dc3545;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .search-result-asset {
            color: #28a745;
            margin-left: 20px;
        }

        .search-count {
            color: #007bff;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        #searchButton {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(212, 168, 90, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 999;
        }

        #closeSearchButton {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #closeSearchButton:hover {
            background-color: #0056b3;
        }

        /* æ·»åŠ æ»‘åŠ¨æç¤ºæ ·å¼ */
        .list-item.swipe-right {
            background-color: rgba(220, 53, 69, 0.2) !important; /* å³æ»‘åˆ é™¤ - çº¢è‰² */
        }

        .list-item.swipe-left {
            background-color: rgba(40, 167, 69, 0.2) !important; /* å·¦æ»‘ç¼–è¾‘ - ç»¿è‰² */
        }

        /* æ·»åŠ èµ„äº§ç¼–å·çš„æ ·å¼ */
        .asset-number {
            display: inline-block;
            min-width: 24px;
            color: #6c757d;
            font-weight: bold;
        }

        /* åœ°ç‚¹ç¼–è¾‘æŒ‰é’®æ ·å¼ */
        .location-edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 2px 8px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .location-edit-btn:hover {
            opacity: 1;
        }

        /* åœ°ç‚¹æ‰¹é‡ç¼–è¾‘æ¨¡æ€æ¡†æ ·å¼ */
        #locationEditModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #locationEditModal h3 {
            margin-bottom: 10px;
            color: #007bff;
            text-align: center;
        }

        #locationEditInput {
            width: 100%;
            height: 400px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 4px;
            margin-bottom: 10px;
            resize: vertical;
        }

        #saveLocationEditButton {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #saveLocationEditButton:hover {
            background-color: #0056b3;
        }

        /* æ·»åŠ å›åˆ°åº•éƒ¨æŒ‰é’®æ ·å¼ */
        #scrollBottomButton {
            position: fixed;
            left: 20px;
            bottom: 70px;
            width: 40px;
            height: 40px;
            background-color: rgba(40, 167, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        #scrollBottomButton:hover {
            background-color: rgba(40, 167, 69, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* æ·»åŠ å¤‡ä»½æ¨¡æ€æ¡†æ ·å¼ */
        #backupModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        #backupModal h3, #backupModal h4 {
            margin-bottom: 10px;
            color: #007bff;
            text-align: center;
        }
        
        .backup-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .backup-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .backup-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .backup-buttons button {
            flex: 1;
            min-width: calc(50% - 5px);
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        #manualBackupButton {
            background-color: #28a745;
        }
        
        #manualBackupButton:hover {
            background-color: #218838;
        }
        
        #restoreBackupButton {
            background-color: #17a2b8;
        }
        
        #restoreBackupButton:hover {
            background-color: #138496;
        }
        
        #exportBackupButton {
            background-color: #007bff;
        }
        
        #exportBackupButton:hover {
            background-color: #0069d9;
        }
        
        #importBackupButton {
            background-color: #6c757d;
        }
        
        #importBackupButton:hover {
            background-color: #5a6268;
        }
        
        .backup-options {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .backup-options label {
            display: block;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .backup-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .backup-item:last-child {
            border-bottom: none;
        }
        
        .backup-item-info {
            flex: 2;
        }
        
        .backup-item-time {
            font-weight: bold;
            color: #007bff;
        }
        
        .backup-item-desc, .backup-item-count {
            color: #6c757d;
            font-size: 12px;
        }
        
        .backup-item-actions {
            flex: 1;
            display: flex;
            justify-content: flex-end;
            gap: 5px;
        }
        
        .backup-item-actions button {
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            color: white;
            cursor: pointer;
        }
        
        .backup-restore-btn {
            background-color: #17a2b8;
        }
        
        .backup-export-btn {
            background-color: #007bff;
        }
        
        .backup-delete-btn {
            background-color: #dc3545;
        }
        
        #closeBackupModalButton {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        #closeBackupModalButton:hover {
            background-color: #0056b3;
        }
        
        .no-backup, .backup-error {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }
        
        .backup-error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div id="overlay"></div>
    <div id="editModal">
        <input type="text" id="editInput" placeholder="è¾“å…¥ä¿®æ”¹åçš„å†…å®¹">
        <button id="saveEditButton">ä¿å­˜ä¿®æ”¹</button>
    </div>
    <div id="importModal">
        <textarea id="importInput" placeholder="è¯·è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®ï¼Œæ¯è¡Œä¸€æ¡"></textarea>
        <button id="savebatchAddButton">ç¡®è®¤ä¿å­˜</button>
    </div>
    <div id="editAllModal">
        <textarea id="editAllInput" placeholder="è¯·ä¿®æ”¹æ•°æ®ï¼Œæ¯è¡Œä¸€æ¡"></textarea>
        <button id="saveEditAllButton">ç¡®è®¤ä¿®æ”¹</button>
    </div>
    <div id="searchModal">
        <input type="text" id="searchInput" placeholder="è¾“å…¥è¦æœç´¢çš„èµ„äº§å…³é”®è¯">
        <div id="searchResults"></div>
        <button id="closeSearchButton">å…³é—­</button>
    </div>

    <div id="dataList"></div>
    <button id="searchButton" title="æœç´¢èµ„äº§">ğŸ”</button>
    <button id="collapseAllButton" title="æŠ˜å /å±•å¼€">â–¼</button>
    <div class="input-container">
        <input type="text" id="itemInput" placeholder="è¾“å…¥å†…å®¹å¹¶é€‰æ‹©å»ºè®®é¡¹...">
        <div id="suggestions"></div>
        <div class="button-group">
            <button id="exportButton">å¯¼å‡ºTXT</button>
            <button id="batchAddButton">æ‰¹é‡æ·»åŠ </button>
            <button id="batchEditButton">æ‰¹é‡ä¿®æ”¹</button>
            <button id="deleteAllButton">åˆ é™¤å…¨éƒ¨</button>
        </div>
    </div>
    <div id="guideModal">
        <div class="guide-content">
            å¿«é€Ÿæ“ä½œæŒ‡å—ï¼š

            åŸºæœ¬æ“ä½œï¼š
            - åœ¨è¾“å…¥æ¡†è¾“å…¥å†…å®¹åç‚¹å‡»å›è½¦é”®æˆ–æŒ‰ä¸‹æ·»åŠ æŒ‰é’®å¯æ·»åŠ æ–°æ•°æ®è¡Œ
            - é•¿æŒ‰ä»»ä½•æ•°æ®è¡Œå¯å¤åˆ¶è¯¥è¡Œå†…å®¹
            - å‘å·¦æ»‘åŠ¨æ•°æ®è¡Œå¯ç¼–è¾‘å†…å®¹
            - å‘å³æ»‘åŠ¨æ•°æ®è¡Œå¯åˆ é™¤å†…å®¹ï¼ˆåœ°ç‚¹è¡Œä¼šåŒæ—¶åˆ é™¤å…¶æ‰€æœ‰èµ„äº§ï¼‰
            
            åœ°ç‚¹ç®¡ç†ï¼š
            - ä»¥@å¼€å¤´çš„è¡Œä¼šè‡ªåŠ¨æ ‡è®°ä¸ºåœ°ç‚¹è¡Œï¼ˆé»„åº•çº¢å­—ï¼‰
            - ç‚¹å‡»åœ°ç‚¹è¡Œå¯å±•å¼€/æŠ˜å è¯¥åœ°ç‚¹ä¸‹çš„æ‰€æœ‰èµ„äº§
            - ç‚¹å‡»åœ°ç‚¹è¡Œå³ä¾§çš„âœï¸æŒ‰é’®å¯æ‰¹é‡ç¼–è¾‘è¯¥åœ°ç‚¹åŠå…¶æ‰€æœ‰èµ„äº§
            - ç›¸åŒåœ°ç‚¹åç§°ä¸å…è®¸é‡å¤æ·»åŠ 
            - ç¬¬ä¸€ä¸ªåœ°ç‚¹è¡Œ"@æ¨¡æ¿èµ„äº§"ç”¨äºå­˜æ”¾æ¨¡æ¿æ•°æ®ï¼Œä¸ä¼šè¢«å¯¼å‡º
            
            æ‰¹é‡æ“ä½œï¼š
            - ç‚¹å‡»"æ‰¹é‡æ·»åŠ "å¯ä¸€æ¬¡æ€§æ·»åŠ å¤šæ¡æ•°æ®ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰
            - ç‚¹å‡»"æ‰¹é‡ä¿®æ”¹"å¯ç¼–è¾‘å…¨éƒ¨æ•°æ®å†…å®¹
            - ç‚¹å‡»"åˆ é™¤å…¨éƒ¨"å¯æ¸…ç©ºé™¤æ¨¡æ¿èµ„äº§å¤–çš„æ‰€æœ‰æ•°æ®
            - ç‚¹å‡»"å¯¼å‡ºTXT"å¯å°†æ•°æ®ï¼ˆé™¤æ¨¡æ¿èµ„äº§å¤–ï¼‰å¯¼å‡ºä¸ºæ–‡æœ¬æ–‡ä»¶
            
            è¾…åŠ©åŠŸèƒ½ï¼š
            - å³ä¸‹è§’â†‘æŒ‰é’®å¯å¿«é€Ÿè¿”å›åˆ—è¡¨é¡¶éƒ¨
            - å³ä¸‹è§’â–¼/â–¶æŒ‰é’®å¯ä¸€é”®æŠ˜å /å±•å¼€æ‰€æœ‰åœ°ç‚¹
            - å³ä¸‹è§’ğŸ”æŒ‰é’®å¯æœç´¢èµ„äº§ï¼Œç»“æœæŒ‰åœ°ç‚¹åˆ†ç»„æ˜¾ç¤º
            
            ä½¿ç”¨æŠ€å·§ï¼š
            - æ¯ä¸ªåœ°ç‚¹ä¸‹çš„èµ„äº§ä¼šè‡ªåŠ¨ç¼–å·ï¼ˆ1. 2. 3. ...ï¼‰
            - æ‰¹é‡å¯¼å…¥æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥åœ°ç‚¹æ˜¯å¦é‡å¤
            - é•¿æŒ‰å¤åˆ¶å†…å®¹å¯ç”¨äºå¿«é€Ÿåˆ›å»ºç±»ä¼¼æ¡ç›®
            - æŠ˜å ä¸å¸¸ç”¨åœ°ç‚¹å¯ä½¿åˆ—è¡¨æ›´ç®€æ´
            
            æç¤ºï¼šè¯¥åº”ç”¨æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œæ¸…é™¤æµè§ˆå™¨æ•°æ®å¯èƒ½å¯¼è‡´ä¿¡æ¯ä¸¢å¤±ï¼Œå»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½ã€‚
        </div>
        <button id="closeGuideButton">æˆ‘çŸ¥é“äº†</button>
    </div>

    <!-- æ·»åŠ åœ°ç‚¹æ‰¹é‡ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="locationEditModal">
        <h3>ç¼–è¾‘åœ°ç‚¹åŠèµ„äº§</h3>
        <textarea id="locationEditInput" placeholder="ç¼–è¾‘åœ°ç‚¹åŠå…¶æ‰€æœ‰èµ„äº§ï¼Œæ¯è¡Œä¸€æ¡"></textarea>
        <button id="saveLocationEditButton">ä¿å­˜ä¿®æ”¹</button>
    </div>

    <!-- æ·»åŠ å¤‡ä»½æ¨¡æ€æ¡† -->
    <div id="backupModal">
        <h3>æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3>
        <div class="backup-info">
            <p>ä¸Šæ¬¡è‡ªåŠ¨å¤‡ä»½æ—¶é—´ï¼š<span id="lastBackupTime">æ— </span></p>
            <p>å½“å‰è‡ªåŠ¨å¤‡ä»½çŠ¶æ€ï¼š<span id="backupStatus">å·²å¯ç”¨</span></p>
        </div>
        <div class="backup-buttons">
            <button id="manualBackupButton">ç«‹å³å¤‡ä»½</button>
            <button id="restoreBackupButton">æ¢å¤å¤‡ä»½</button>
            <button id="exportBackupButton">å¯¼å‡ºå¤‡ä»½æ–‡ä»¶</button>
            <button id="importBackupButton">å¯¼å…¥å¤‡ä»½æ–‡ä»¶</button>
            <input type="file" id="backupFileInput" accept=".json" style="display: none;">
        </div>
        <div class="backup-options">
            <label>
                <input type="checkbox" id="autoBackupEnabled" checked>
                å¯ç”¨è‡ªåŠ¨å¤‡ä»½
            </label>
            <label>
                å¤‡ä»½é¢‘ç‡ï¼š
                <select id="backupFrequency">
                    <option value="3600000">æ¯å°æ—¶</option>
                    <option value="86400000" selected>æ¯å¤©</option>
                    <option value="604800000">æ¯å‘¨</option>
                </select>
            </label>
            <label>
                ä¿ç•™å¤‡ä»½æ•°ï¼š
                <select id="backupRetention">
                    <option value="1">1ä¸ª</option>
                    <option value="3" selected>3ä¸ª</option>
                    <option value="5">5ä¸ª</option>
                    <option value="10">10ä¸ª</option>
                </select>
            </label>
        </div>
        <div class="backup-list">
            <h4>å¯ç”¨å¤‡ä»½åˆ—è¡¨</h4>
            <div id="backupsList"></div>
        </div>
        <button id="closeBackupModalButton">å…³é—­</button>
    </div>

    <script>
        let items = [];
        let currentEditIndex = null;
        let db;
        let isAllCollapsed = false;
        let saveItemTimeout = null; // æ·»åŠ  saveItemTimeout å˜é‡å£°æ˜
        
        const dataList = document.getElementById('dataList');
        const itemInput = document.getElementById('itemInput');
        const suggestions = document.getElementById('suggestions');
        const exportButton = document.getElementById('exportButton');
        const batchEditButton = document.getElementById('batchEditButton');
        const editModal = document.getElementById('editModal');
        const editInput = document.getElementById('editInput');
        const saveEditButton = document.getElementById('saveEditButton');
        const overlay = document.getElementById('overlay');
        const editAllModal = document.getElementById('editAllModal');
        const importModal = document.getElementById('importModal');
        const importInput = document.getElementById('importInput');
        const batchAddButton = document.getElementById('batchAddButton');
        const savebatchAddButton = document.getElementById('savebatchAddButton');
        const deleteAllButton = document.getElementById('deleteAllButton');
        const guideModal = document.getElementById('guideModal');
        const closeGuideButton = document.getElementById('closeGuideButton');
        const collapseAllButton = document.getElementById('collapseAllButton');
        const searchButton = document.getElementById('searchButton');
        const searchModal = document.getElementById('searchModal');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const closeSearchButton = document.getElementById('closeSearchButton');
        const locationEditModal = document.getElementById('locationEditModal');
        const locationEditInput = document.getElementById('locationEditInput');
        const saveLocationEditButton = document.getElementById('saveLocationEditButton');
        let currentLocationEditIndex = -1;

        // æ·»åŠ å¤‡ä»½ç›¸å…³å˜é‡
        let backupSettings = {
            enabled: true,
            frequency: 86400000, // é»˜è®¤æ¯å¤©å¤‡ä»½ä¸€æ¬¡ï¼ˆæ¯«ç§’ï¼‰
            retention: 3,        // é»˜è®¤ä¿ç•™3ä¸ªå¤‡ä»½
            lastBackupTime: null // ä¸Šæ¬¡å¤‡ä»½æ—¶é—´
        };
        let backupTimer = null;
        let backups = [];       // å¤‡ä»½åˆ—è¡¨
        
        // æ·»åŠ å¤‡ä»½ç›¸å…³DOMå¼•ç”¨
        const backupModal = document.getElementById('backupModal');
        const lastBackupTimeSpan = document.getElementById('lastBackupTime');
        const backupStatusSpan = document.getElementById('backupStatus');
        const manualBackupButton = document.getElementById('manualBackupButton');
        const restoreBackupButton = document.getElementById('restoreBackupButton');
        const exportBackupButton = document.getElementById('exportBackupButton');
        const importBackupButton = document.getElementById('importBackupButton');
        const backupFileInput = document.getElementById('backupFileInput');
        const autoBackupEnabledCheckbox = document.getElementById('autoBackupEnabled');
        const backupFrequencySelect = document.getElementById('backupFrequency');
        const backupRetentionSelect = document.getElementById('backupRetention');
        const backupsList = document.getElementById('backupsList');
        const closeBackupModalButton = document.getElementById('closeBackupModalButton');
        
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ·»åŠ äº¤äº’äº‹ä»¶ï¼Œä¿®å¤ä¹‹å‰å¯èƒ½çš„é—®é¢˜
        function setupEventDelegation() {
            try {
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
                dataList.removeEventListener('click', handleListClick);
                dataList.removeEventListener('mousedown', handleListMouseDown);
                dataList.removeEventListener('mousemove', handleListMouseMove);
                dataList.removeEventListener('mouseup', handleListMouseUp);
                dataList.removeEventListener('mouseleave', handleListMouseLeave);
                dataList.removeEventListener('touchstart', handleListTouchStart);
                dataList.removeEventListener('touchmove', handleListTouchMove);
                dataList.removeEventListener('touchend', handleListTouchEnd);
                dataList.removeEventListener('touchcancel', handleListTouchCancel);
                dataList.removeEventListener('dblclick', handleListDblClick);
                
                // æ·»åŠ å§”æ‰˜äº‹ä»¶å¤„ç†
                dataList.addEventListener('click', handleListClick);
                dataList.addEventListener('mousedown', handleListMouseDown);
                dataList.addEventListener('mousemove', handleListMouseMove);
                dataList.addEventListener('mouseup', handleListMouseUp);
                dataList.addEventListener('mouseleave', handleListMouseLeave);
                dataList.addEventListener('touchstart', handleListTouchStart);
                dataList.addEventListener('touchmove', handleListTouchMove);
                dataList.addEventListener('touchend', handleListTouchEnd);
                dataList.addEventListener('touchcancel', handleListTouchCancel);
                dataList.addEventListener('dblclick', handleListDblClick);
                
                console.log('äº‹ä»¶å§”æ‰˜è®¾ç½®å®Œæˆ');
            } catch (error) {
                console.error('è®¾ç½®äº‹ä»¶å§”æ‰˜æ—¶å‡ºé”™:', error);
                
                // é™çº§å¤„ç†ï¼šç¡®ä¿åŸºæœ¬çš„æŠ˜å /å±•å¼€åŠŸèƒ½å¯ç”¨
                try {
                    const locationItems = document.querySelectorAll('.location-item');
                    locationItems.forEach(item => {
                        item.addEventListener('click', function(e) {
                            if (!e.target.closest('.location-edit-btn')) {
                                const locationIndex = parseInt(this.getAttribute('data-location-index'));
                                const assets = document.querySelectorAll(`[data-belongs-to="${locationIndex}"]`);
                                const collapseIcon = this.querySelector('.collapse-icon');
                                
                                const isCollapsed = assets.length > 0 && assets[0].style.display === 'none';
                                
                                assets.forEach(asset => {
                                    asset.style.display = isCollapsed ? 'flex' : 'none';
                                });
                                
                                collapseIcon.textContent = isCollapsed ? 'â–¼' : 'â–¶';
                            }
                        });
                    });
                    
                    const editButtons = document.querySelectorAll('.location-edit-btn');
                    editButtons.forEach(button => {
                        button.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const locationIndex = parseInt(this.getAttribute('data-location'));
                            openLocationEditor(locationIndex);
                        });
                    });
                    
                    console.log('é™çº§äº‹ä»¶ç»‘å®šè®¾ç½®å®Œæˆ');
                } catch (fallbackError) {
                    console.error('é™çº§äº‹ä»¶ç»‘å®šå¤±è´¥:', fallbackError);
                }
            }
        }

        // ä¿®æ”¹ä¿å­˜æ•°æ®åˆ°IndexedDBçš„å‡½æ•°ï¼Œç®€åŒ–é˜²æŠ–é€»è¾‘
        const saveItem = (value) => {
            try {
                const transaction = db.transaction(['items'], 'readwrite');
                const store = transaction.objectStore('items');
                
                const request = store.add({ value });
                
                request.onerror = (event) => {
                    console.error('ä¿å­˜æ•°æ®é”™è¯¯ï¼š', event.target.error);
                };
                
                transaction.oncomplete = () => {
                    console.log('æ•°æ®ä¿å­˜æˆåŠŸï¼ŒåŠ è½½æœ€æ–°æ•°æ®');
                    loadItems(); // ç›´æ¥è§¦å‘é‡æ–°åŠ è½½
                };
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
                alert('ä¿å­˜æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            }
        };

        // ç¡®ä¿IndexedDBåˆå§‹åŒ–ä»£ç å¯é 
        const initDB = () => {
            try {
                const request = indexedDB.open('ItemsDB', 1);
                
                request.onerror = (event) => {
                    console.error('æ•°æ®åº“é”™è¯¯ï¼š', event.target.error);
                    alert('æ— æ³•æ‰“å¼€æ•°æ®åº“ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®æˆ–åˆ·æ–°é¡µé¢');
                };

                request.onupgradeneeded = (event) => {
                    console.log('æ•°æ®åº“å‡çº§ä¸­...');
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('items')) {
                        db.createObjectStore('items', { keyPath: 'id', autoIncrement: true });
                        console.log('åˆ›å»ºitemså­˜å‚¨å¯¹è±¡æˆåŠŸ');
                    }
                };

                request.onsuccess = (event) => {
                    console.log('æ•°æ®åº“æ‰“å¼€æˆåŠŸ');
                    db = event.target.result;
                    
                    // ç¡®ä¿æ•°æ®åº“è¿æ¥æœ‰æ•ˆ
                    db.onversionchange = () => {
                        db.close();
                        alert('æ•°æ®åº“å·²è¿‡æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    };
                    
                    // ç«‹å³åŠ è½½æ•°æ®
                    loadItems();
                    
                    // åˆå§‹åŒ–å¤‡ä»½ç³»ç»Ÿ
                    setupBackup();
                };
            } catch (error) {
                console.error('åˆå§‹åŒ–æ•°æ®åº“æ—¶å‡ºé”™:', error);
                alert('åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            }
        };

        // ä¿®æ”¹ä»IndexedDBåŠ è½½æ•°æ®çš„å‡½æ•°
        const loadItems = () => {
            const transaction = db.transaction(['items'], 'readonly');
            const store = transaction.objectStore('items');
            const request = store.getAll();

            request.onerror = (event) => {
                console.error('åŠ è½½æ•°æ®é”™è¯¯ï¼š', event.target.error);
            };

            request.onsuccess = () => {
                // ç›´æ¥åŠ è½½æ•°æ®å¹¶æ¸²æŸ“ï¼Œä¸ä½¿ç”¨å»¶è¿Ÿ
                items = request.result.map(item => item.value);
                console.log(`æ•°æ®åŠ è½½æˆåŠŸï¼Œå…± ${items.length} æ¡è®°å½•`);
                refreshList();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæŒ‡å—
                if (items.length === 0) {
                    guideModal.style.display = 'block';
                    overlay.style.display = 'block';
                }
            };
        };

        // æ›´æ–°IndexedDBä¸­çš„æ•°æ®
        const updateItem = (index, newValue) => {
            try {
                const transaction = db.transaction(['items'], 'readwrite');
                const store = transaction.objectStore('items');
                
                // å…ˆè·å–è¦æ›´æ–°çš„è®°å½•
                const cursorRequest = store.openCursor();
                let count = 0;
                
                cursorRequest.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        if (count === index) {
                            cursor.update({ id: cursor.key, value: newValue });
                        }
                        count++;
                        cursor.continue();
                    }
                };

                transaction.oncomplete = () => {
                    console.log('æ›´æ–°æ•°æ®æˆåŠŸï¼Œé‡æ–°åŠ è½½æ•°æ®');
                    loadItems(); // ç›´æ¥åŠ è½½æ•°æ®
                };
            } catch (error) {
                console.error('æ›´æ–°æ•°æ®æ—¶å‡ºé”™:', error);
                alert('æ›´æ–°æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            }
        };

        // ä¼˜åŒ–åˆ é™¤æ•°æ®çš„å‡½æ•°
        const deleteItem = (index) => {
            try {
                const transaction = db.transaction(['items'], 'readwrite');
                const store = transaction.objectStore('items');
                
                const cursorRequest = store.openCursor();
                let count = 0;
                
                cursorRequest.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        if (count === index) {
                            cursor.delete();
                        }
                        count++;
                        cursor.continue();
                    }
                };

                transaction.oncomplete = () => {
                    console.log('åˆ é™¤æ•°æ®æˆåŠŸï¼Œé‡æ–°åŠ è½½æ•°æ®');
                    loadItems(); // ç›´æ¥åŠ è½½æ•°æ®
                };
            } catch (error) {
                console.error('åˆ é™¤æ•°æ®æ—¶å‡ºé”™:', error);
                alert('åˆ é™¤æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            }
        };

        // ä¼˜åŒ–åˆ é™¤åœ°ç‚¹åŠå…¶èµ„äº§çš„å‡½æ•°
        function deleteLocationAndAssets(locationIndex) {
            // ç¡®ä¿è¯¥ç´¢å¼•å­˜åœ¨ä¸”æ˜¯åœ°ç‚¹è¡Œ
            if (!items[locationIndex] || !items[locationIndex].startsWith('@')) {
                return;
            }
            
            // ç¬¬ä¸€ä¸ªåœ°ç‚¹è¡Œï¼ˆæ¨¡æ¿èµ„äº§ï¼‰ä¸å…è®¸åˆ é™¤
            if (locationIndex === 0) {
                showErrorToast('æ¨¡æ¿åœ°ç‚¹ä¸èƒ½åˆ é™¤');
                return;
            }
            
            // æ‰¾å‡ºæ‰€æœ‰å±äºè¯¥åœ°ç‚¹çš„èµ„äº§èŒƒå›´
            let nextLocationIndex = locationIndex + 1;
            while (nextLocationIndex < items.length && !items[nextLocationIndex].startsWith('@')) {
                nextLocationIndex++;
            }
            
            // è®¡ç®—è¦åˆ é™¤çš„é¡¹ç›®æ•°
            const deleteCount = nextLocationIndex - locationIndex;
            
            // æ˜¾ç¤ºåˆ é™¤ä¸­æç¤º
            showToast('æ­£åœ¨åˆ é™¤ä¸­...');
            
            // ä½¿ç”¨äº‹åŠ¡åŒæ­¥å¤„ç†æ•°æ®
            const transaction = db.transaction(['items'], 'readwrite');
            const store = transaction.objectStore('items');
            
            // å…ˆè·å–æ‰€æœ‰æ•°æ®
            const getAllRequest = store.getAll();
            
            getAllRequest.onsuccess = () => {
                const allItems = getAllRequest.result;
                
                // æ¸…é™¤storeåé‡æ–°æ·»åŠ æ•°æ®ï¼Œè·³è¿‡è¦åˆ é™¤çš„éƒ¨åˆ†
                store.clear().onsuccess = () => {
                    // åŒæ­¥æ·»åŠ åˆ é™¤å‰çš„æ•°æ®
                    for (let i = 0; i < locationIndex; i++) {
                        store.add(allItems[i]);
                    }
                    
                    // åŒæ­¥æ·»åŠ åˆ é™¤åçš„æ•°æ®
                    for (let i = locationIndex + deleteCount; i < allItems.length; i++) {
                        store.add(allItems[i]);
                    }
                    
                    transaction.oncomplete = () => {
                        loadItems();
                        showToast(`å·²åˆ é™¤"${items[locationIndex]}"åŠå…¶æ‰€æœ‰èµ„äº§`);
                    };
                };
            };
        }

        // ä¿®æ”¹ refreshList å‡½æ•°ï¼Œç®€åŒ–å¤„ç†é€»è¾‘
        function refreshList() {
            console.log('åˆ·æ–°åˆ—è¡¨ä¸­ï¼Œæ•°æ®æ¡æ•°:', items.length);
            
            // æš‚æ—¶ç¦ç”¨é«˜çº§åŠŸèƒ½ï¼Œç¡®ä¿åŸºæœ¬æ˜¾ç¤ºæ­£å¸¸
            const useSimpleMode = true;
            
            if (useSimpleMode || items.length < 500) {
                // ä½¿ç”¨ç®€å•æ¨¡å¼æ¸²æŸ“ï¼Œç¡®ä¿å¯ä»¥æ˜¾ç¤º
                renderSimpleList();
            } else {
                // ä½¿ç”¨åˆ†æ‰¹æ¨¡å¼æ¸²æŸ“
                if (appSettings && typeof appSettings.adjustForDataSize === 'function') {
                    appSettings.adjustForDataSize();
                    
                    if (appSettings.usePagination) {
                        renderPaginatedItems();
                    } else {
                        renderBatchedItems();
                    }
                } else {
                    renderSimpleList(); // é™çº§åˆ°ç®€å•æ¸²æŸ“
                }
            }
        }

        // æ·»åŠ ç®€å•æ¸²æŸ“å‡½æ•°ï¼Œç¡®ä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨
        function renderSimpleList() {
            // ä½¿ç”¨DocumentFragmentå‡å°‘é‡æ’é‡ç»˜
            const fragment = document.createDocumentFragment();
            let currentLocationIndex = -1;
            let assetCounter = 0;
            
            // åˆ›å»ºå’Œå¡«å……æ¯ä¸ªåˆ—è¡¨é¡¹
            items.forEach((item, index) => {
                const listItem = document.createElement('div');
                
                if (item.startsWith('@')) {
                    currentLocationIndex = index;
                    assetCounter = 0;
                    listItem.className = 'list-item location-item';
                    listItem.setAttribute('data-location-index', index);
                    listItem.setAttribute('data-index', index);
                    
                    listItem.innerHTML = `
                        <div class="item-text">
                            <span class="collapse-icon">${index === 0 ? 'â–¶' : 'â–¼'}</span> ${item}
                        </div>
                        <button class="location-edit-btn" data-location="${index}" title="æ‰¹é‡ç¼–è¾‘æ­¤åœ°ç‚¹åŠèµ„äº§">âœï¸</button>
                    `;
                } else {
                    assetCounter++;
                    listItem.className = 'list-item asset-item';
                    listItem.setAttribute('data-belongs-to', currentLocationIndex);
                    listItem.setAttribute('data-index', index);
                    
                    if (currentLocationIndex === 0) {
                        listItem.style.display = 'none';
                    }
                    
                    listItem.innerHTML = `
                        <div class="item-text"><span class="asset-number">${assetCounter}. </span>${item}</div>
                    `;
                }
                
                fragment.appendChild(listItem);
            });
            
            // æ¸…ç©ºå®¹å™¨å¹¶ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰å…ƒç´ 
            dataList.innerHTML = '';
            dataList.appendChild(fragment);
            
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ·»åŠ äº‹ä»¶å¤„ç†
            setupEventDelegation();
        }
        
        // æ·»åŠ åˆ†é¡µæ¸²æŸ“å‡½æ•°
        function renderPaginatedItems() {
            const totalItems = items.length;
            const totalPages = Math.ceil(totalItems / appSettings.pageSize);
            
            // ç¡®ä¿å½“å‰é¡µåœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (appSettings.currentPage < 1) appSettings.currentPage = 1;
            if (appSettings.currentPage > totalPages) appSettings.currentPage = totalPages;
            
            // è®¡ç®—å½“å‰é¡µçš„èµ·å§‹å’Œç»“æŸç´¢å¼•
            const startIdx = (appSettings.currentPage - 1) * appSettings.pageSize;
            const endIdx = Math.min(startIdx + appSettings.pageSize, totalItems);
            
            // æ˜¾ç¤ºåŠ è½½æç¤ºå’Œåˆ†é¡µæ§åˆ¶
            dataList.innerHTML = `
                <div class="pagination-controls">
                    <span>æ€»å…± ${totalItems} é¡¹ï¼Œç¬¬ ${appSettings.currentPage}/${totalPages} é¡µ</span>
                    <div class="pagination-buttons">
                        <button id="prevPage" ${appSettings.currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                        <button id="nextPage" ${appSettings.currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
                <div class="loading-indicator">æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div>
            `;
            
            // è·å–åˆ†é¡µæŒ‰é’®å¼•ç”¨
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            prevPageBtn.addEventListener('click', () => {
                if (appSettings.currentPage > 1) {
                    appSettings.currentPage--;
                    refreshList();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                if (appSettings.currentPage < totalPages) {
                    appSettings.currentPage++;
                    refreshList();
                }
            });
            
            // ä½¿ç”¨setTimeouté¿å…é˜»å¡UI
            setTimeout(() => {
                const fragment = document.createDocumentFragment();
                let currentLocationIndex = -1;
                let assetCounter = 0;
                
                // æŸ¥æ‰¾æœ€è¿‘çš„åœ°ç‚¹è¡Œç´¢å¼•
                for (let i = startIdx - 1; i >= 0; i--) {
                    if (items[i].startsWith('@')) {
                        currentLocationIndex = i;
                        
                        // è®¡ç®—æ­¤åœ°ç‚¹ä¸‹å·²æœ‰å¤šå°‘èµ„äº§
                        for (let j = i + 1; j < startIdx; j++) {
                            if (!items[j].startsWith('@')) {
                                assetCounter++;
                            } else {
                                break;
                            }
                        }
                        break;
                    }
                }
                
                // åˆ é™¤åŠ è½½æç¤ºä½†ä¿ç•™åˆ†é¡µæ§åˆ¶
                const loadingIndicator = document.querySelector('.loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                // åˆ›å»ºæ•°æ®å®¹å™¨
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'paginated-items';
                
                // æ¸²æŸ“å½“å‰é¡µçš„æ•°æ®é¡¹
                for (let i = startIdx; i < endIdx; i++) {
                    const item = items[i];
                    const listItem = document.createElement('div');
                    
                    if (item.startsWith('@')) {
                        currentLocationIndex = i;
                        assetCounter = 0;
                        listItem.className = 'list-item location-item';
                        listItem.setAttribute('data-location-index', i);
                        listItem.setAttribute('data-index', i);
                        
                        listItem.innerHTML = `
                            <div class="item-text">
                                <span class="collapse-icon">${i === 0 ? 'â–¶' : 'â–¼'}</span> ${item}
                            </div>
                            <button class="location-edit-btn" data-location="${i}" title="æ‰¹é‡ç¼–è¾‘æ­¤åœ°ç‚¹åŠèµ„äº§">âœï¸</button>
                        `;
                    } else {
                        assetCounter++;
                        listItem.className = 'list-item asset-item';
                        listItem.setAttribute('data-belongs-to', currentLocationIndex);
                        listItem.setAttribute('data-index', i);
                        
                        if (currentLocationIndex === 0) {
                            listItem.style.display = 'none';
                        }
                        
                        listItem.innerHTML = `
                            <div class="item-text"><span class="asset-number">${assetCounter}. </span>${item}</div>
                        `;
                    }
                    
                    itemsContainer.appendChild(listItem);
                }
                
                fragment.appendChild(itemsContainer);
                dataList.appendChild(fragment);
                
                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ·»åŠ äº‹ä»¶å¤„ç†
                setupEventDelegation();
            }, 10);
        }
        
        // æ·»åŠ åˆ†æ‰¹æ¸²æŸ“å‡½æ•°ï¼Œç”¨äºå¤„ç†å¤§é‡æ•°æ®
        function renderBatchedItems() {
            let batchSize = 100; // æ¯æ‰¹æ¸²æŸ“çš„é¡¹ç›®æ•°
            let currentBatch = 0;
            let totalBatches = Math.ceil(items.length / batchSize);
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            dataList.innerHTML = '<div class="loading-indicator">æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div>';
            
            function renderBatch() {
                if (currentBatch >= totalBatches) {
                    // æ‰€æœ‰æ‰¹æ¬¡éƒ½å·²æ¸²æŸ“å®Œæˆï¼Œè®¾ç½®äº‹ä»¶å§”æ‰˜
                    setupEventDelegation();
                    return;
                }
                
                const fragment = document.createDocumentFragment();
                let startIndex = currentBatch * batchSize;
                let endIndex = Math.min(startIndex + batchSize, items.length);
                let currentLocationIndex = -1;
                let assetCounter = 0;
                
                // æŸ¥æ‰¾æœ€è¿‘çš„åœ°ç‚¹è¡Œç´¢å¼•
                for (let i = startIndex - 1; i >= 0; i--) {
                    if (items[i].startsWith('@')) {
                        currentLocationIndex = i;
                        
                        // è®¡ç®—æ­¤åœ°ç‚¹ä¸‹å·²æœ‰å¤šå°‘èµ„äº§
                        for (let j = i + 1; j < startIndex; j++) {
                            if (!items[j].startsWith('@')) {
                                assetCounter++;
                            } else {
                                break;
                            }
                        }
                        break;
                    }
                }
                
                // åˆ é™¤åŠ è½½æç¤º(ä»…ç¬¬ä¸€æ‰¹)
                if (currentBatch === 0) {
                    dataList.innerHTML = '';
                }
                
                // åˆ›å»ºæ­¤æ‰¹æ¬¡çš„å…ƒç´ 
                for (let i = startIndex; i < endIndex; i++) {
                    const item = items[i];
                    const listItem = document.createElement('div');
                    
                    if (item.startsWith('@')) {
                        currentLocationIndex = i;
                        assetCounter = 0;
                        listItem.className = 'list-item location-item';
                        listItem.setAttribute('data-location-index', i);
                        listItem.setAttribute('data-index', i);
                        
                        listItem.innerHTML = `
                            <div class="item-text">
                                <span class="collapse-icon">${i === 0 ? 'â–¶' : 'â–¼'}</span> ${item}
                            </div>
                            <button class="location-edit-btn" data-location="${i}" title="æ‰¹é‡ç¼–è¾‘æ­¤åœ°ç‚¹åŠèµ„äº§">âœï¸</button>
                        `;
                    } else {
                        assetCounter++;
                        listItem.className = 'list-item asset-item';
                        listItem.setAttribute('data-belongs-to', currentLocationIndex);
                        listItem.setAttribute('data-index', i);
                        
                        if (currentLocationIndex === 0) {
                            listItem.style.display = 'none';
                        }
                        
                        listItem.innerHTML = `
                            <div class="item-text"><span class="asset-number">${assetCounter}. </span>${item}</div>
                        `;
                    }
                    
                    fragment.appendChild(listItem);
                }
                
                dataList.appendChild(fragment);
                
                // å®‰æ’ä¸‹ä¸€æ‰¹æ¬¡æ¸²æŸ“
                currentBatch++;
                setTimeout(renderBatch, 0);
            }
            
            // å¼€å§‹æ¸²æŸ“ç¬¬ä¸€æ‰¹
            setTimeout(renderBatch, 0);
        }
        
        // ç‚¹å‡»äº‹ä»¶å¤„ç†
        function handleListClick(e) {
            try {
                const listItem = e.target.closest('.list-item');
                if (!listItem) return;
                
                // åœ°ç‚¹é¡¹çš„ç‚¹å‡»äº‹ä»¶ï¼ˆæŠ˜å /å±•å¼€ï¼‰
                if (listItem.classList.contains('location-item') && 
                    !e.target.classList.contains('location-edit-btn')) {
                    
                    const locationIndex = parseInt(listItem.getAttribute('data-location-index'));
                    const assets = document.querySelectorAll(`[data-belongs-to="${locationIndex}"]`);
                    const collapseIcon = listItem.querySelector('.collapse-icon');
                    
                    console.log(`ç‚¹å‡»åœ°ç‚¹è¡Œ ${locationIndex}ï¼Œæ‰¾åˆ° ${assets.length} ä¸ªèµ„äº§é¡¹`);
                    
                    if (assets.length === 0) return; // æ²¡æœ‰èµ„äº§é¡¹
                    
                    // æ£€æŸ¥ç¬¬ä¸€ä¸ªèµ„äº§æ˜¯å¦éšè—ï¼Œæ¥åˆ¤æ–­å½“å‰çŠ¶æ€
                    const isCollapsed = assets[0].style.display === 'none';
                    
                    // åˆ‡æ¢èµ„äº§æ˜¾ç¤ºçŠ¶æ€
                    assets.forEach(asset => {
                        asset.style.display = isCollapsed ? 'flex' : 'none';
                    });
                    
                    collapseIcon.textContent = isCollapsed ? 'â–¼' : 'â–¶';
                }
                
                // åœ°ç‚¹ç¼–è¾‘æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
                if (e.target.classList.contains('location-edit-btn')) {
                    e.stopPropagation();
                    const locationIndex = parseInt(e.target.getAttribute('data-location'));
                    openLocationEditor(locationIndex);
                }
            } catch (error) {
                console.error('ç‚¹å‡»äº‹ä»¶å¤„ç†å‡ºé”™:', error);
            }
        }
        
        // åŒå‡»äº‹ä»¶å¤„ç† - å¤åˆ¶åŠŸèƒ½
        function handleListDblClick(e) {
            const listItem = e.target.closest('.list-item');
            if (!listItem) return;
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–æŠ˜å å›¾æ ‡ï¼Œä¸è§¦å‘å¤åˆ¶
            if (e.target.classList.contains('action-btn') || 
                e.target.classList.contains('collapse-icon') ||
                e.target.classList.contains('location-edit-btn')) {
                return;
            }
            
            const text = listItem.querySelector('.item-text').textContent.trim();
            copyToClipboard(text);
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }
        
        // è§¦æ‘¸/é¼ æ ‡äº‹ä»¶ç›¸å…³å˜é‡
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isSwiping = false;
        let activeItem = null;
        
        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
        function handleListMouseDown(e) {
            const listItem = e.target.closest('.list-item');
            if (!listItem) return;
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–æŠ˜å å›¾æ ‡ï¼Œä¸è§¦å‘æ»‘åŠ¨
            if (e.target.classList.contains('action-btn') || 
                e.target.classList.contains('collapse-icon') ||
                e.target.classList.contains('location-edit-btn')) {
                return;
            }
            
            touchStartX = e.clientX;
            touchCurrentX = e.clientX;
            isSwiping = true;
            activeItem = listItem;
        }
        
        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        function handleListMouseMove(e) {
            if (!isSwiping || !activeItem) return;
            
            touchCurrentX = e.clientX;
            const diffX = touchCurrentX - touchStartX;
            
            // åº”ç”¨æ»‘åŠ¨æ•ˆæœ
            if (Math.abs(diffX) < 100) { // é™åˆ¶æ»‘åŠ¨è·ç¦»
                activeItem.style.transform = `translateX(${diffX}px)`;
                
                // æ”¹å˜èƒŒæ™¯è‰²ä»¥æç¤ºæ“ä½œ
                if (diffX > 30) { // å³æ»‘ - åˆ é™¤
                    activeItem.style.backgroundColor = 'rgba(220, 53, 69, 0.2)'; // æ·¡çº¢è‰²
                } else if (diffX < -30) { // å·¦æ»‘ - ç¼–è¾‘
                    activeItem.style.backgroundColor = 'rgba(40, 167, 69, 0.2)'; // æ·¡ç»¿è‰²
                } else {
                    activeItem.style.backgroundColor = '';
                }
            }
        }
        
        // é¼ æ ‡æŠ¬èµ·äº‹ä»¶
        function handleListMouseUp(e) {
            if (!isSwiping || !activeItem) return;
            
            const diffX = touchCurrentX - touchStartX;
            const itemIndex = parseInt(activeItem.getAttribute('data-index'));
            
            // é‡ç½®æ ·å¼
            activeItem.style.transition = 'transform 0.3s, background-color 0.3s';
            activeItem.style.transform = 'translateX(0)';
            activeItem.style.backgroundColor = '';
            
            // æ‰§è¡Œç›¸åº”æ“ä½œ
            if (Math.abs(diffX) > 50) { // éœ€è¦æ»‘åŠ¨50pxä»¥ä¸Šæ‰è§¦å‘æ“ä½œ
                if (diffX > 50) { // å³æ»‘ - åˆ é™¤
                    // åˆ¤æ–­æ˜¯å¦ä¸ºåœ°ç‚¹è¡Œ
                    if (activeItem.classList.contains('location-item')) {
                        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤åœ°ç‚¹åŠå…¶æ‰€æœ‰èµ„äº§å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                            deleteLocationAndAssets(itemIndex);
                        }
                    } else {
                        // æ™®é€šèµ„äº§è¡Œåˆ é™¤
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                            deleteItem(itemIndex);
                        }
                    }
                } else if (diffX < -50) { // å·¦æ»‘ - ç¼–è¾‘
                    currentEditIndex = itemIndex;
                    editInput.value = items[itemIndex];
                    editModal.style.display = 'block';
                    overlay.style.display = 'block';
                    
                    // æ·»åŠ è¿™æ®µä»£ç ï¼Œå°†å…‰æ ‡æ”¾åœ¨æ–‡æœ¬æœ«å°¾
                    setTimeout(() => {
                        editInput.focus();
                        editInput.selectionStart = editInput.value.length;
                        editInput.selectionEnd = editInput.value.length;
                    }, 50);
                }
            }
            
            // 300msåç§»é™¤è¿‡æ¸¡æ•ˆæœ
            setTimeout(() => {
                if (activeItem) {
                    activeItem.style.transition = '';
                }
            }, 300);
            
            isSwiping = false;
            activeItem = null;
        }
        
        // é¼ æ ‡ç¦»å¼€äº‹ä»¶
        function handleListMouseLeave(e) {
            if (!isSwiping || !activeItem) return;
            
            // é‡ç½®æ ·å¼
            activeItem.style.transition = 'transform 0.3s, background-color 0.3s';
            activeItem.style.transform = 'translateX(0)';
            activeItem.style.backgroundColor = '';
            
            setTimeout(() => {
                if (activeItem) {
                    activeItem.style.transition = '';
                }
            }, 300);
            
            isSwiping = false;
            activeItem = null;
        }
        
        // è§¦æ‘¸å¼€å§‹äº‹ä»¶
        function handleListTouchStart(e) {
            const listItem = e.target.closest('.list-item');
            if (!listItem) return;
            
            // å¦‚æœè§¦æ‘¸çš„æ˜¯æŒ‰é’®æˆ–æŠ˜å å›¾æ ‡ï¼Œä¸è§¦å‘æ»‘åŠ¨
            if (e.target.classList.contains('action-btn') || 
                e.target.classList.contains('collapse-icon') ||
                e.target.classList.contains('location-edit-btn')) {
                return;
            }
            
            touchStartX = e.touches[0].clientX;
            touchCurrentX = e.touches[0].clientX;
            isSwiping = true;
            activeItem = listItem;
        }
        
        // è§¦æ‘¸ç§»åŠ¨äº‹ä»¶
        function handleListTouchMove(e) {
            if (!isSwiping || !activeItem) return;
            
            touchCurrentX = e.touches[0].clientX;
            const diffX = touchCurrentX - touchStartX;
            
            // åº”ç”¨æ»‘åŠ¨æ•ˆæœ
            if (Math.abs(diffX) < 100) { // é™åˆ¶æ»‘åŠ¨è·ç¦»
                activeItem.style.transform = `translateX(${diffX}px)`;
                
                // æ”¹å˜èƒŒæ™¯è‰²ä»¥æç¤ºæ“ä½œ
                if (diffX > 30) { // å³æ»‘ - åˆ é™¤
                    activeItem.style.backgroundColor = 'rgba(220, 53, 69, 0.2)'; // æ·¡çº¢è‰²
                } else if (diffX < -30) { // å·¦æ»‘ - ç¼–è¾‘
                    activeItem.style.backgroundColor = 'rgba(40, 167, 69, 0.2)'; // æ·¡ç»¿è‰²
                } else {
                    activeItem.style.backgroundColor = '';
                }
            }
        }
        
        // è§¦æ‘¸ç»“æŸäº‹ä»¶
        function handleListTouchEnd(e) {
            if (!isSwiping || !activeItem) return;
            
            const diffX = touchCurrentX - touchStartX;
            const itemIndex = parseInt(activeItem.getAttribute('data-index'));
            
            // é‡ç½®æ ·å¼
            activeItem.style.transition = 'transform 0.3s, background-color 0.3s';
            activeItem.style.transform = 'translateX(0)';
            activeItem.style.backgroundColor = '';
            
            // æ‰§è¡Œç›¸åº”æ“ä½œ
            if (Math.abs(diffX) > 50) { // éœ€è¦æ»‘åŠ¨50pxä»¥ä¸Šæ‰è§¦å‘æ“ä½œ
                if (diffX > 50) { // å³æ»‘ - åˆ é™¤
                    // åˆ¤æ–­æ˜¯å¦ä¸ºåœ°ç‚¹è¡Œ
                    if (activeItem.classList.contains('location-item')) {
                        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤åœ°ç‚¹åŠå…¶æ‰€æœ‰èµ„äº§å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                            deleteLocationAndAssets(itemIndex);
                        }
                    } else {
                        // æ™®é€šèµ„äº§è¡Œåˆ é™¤
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                            deleteItem(itemIndex);
                        }
                    }
                } else if (diffX < -50) { // å·¦æ»‘ - ç¼–è¾‘
                    currentEditIndex = itemIndex;
                    editInput.value = items[itemIndex];
                    editModal.style.display = 'block';
                    overlay.style.display = 'block';
                    
                    // æ·»åŠ è¿™æ®µä»£ç ï¼Œå°†å…‰æ ‡æ”¾åœ¨æ–‡æœ¬æœ«å°¾
                    setTimeout(() => {
                        editInput.focus();
                        editInput.selectionStart = editInput.value.length;
                        editInput.selectionEnd = editInput.value.length;
                    }, 50);
                }
            }
            
            // 300msåç§»é™¤è¿‡æ¸¡æ•ˆæœ
            setTimeout(() => {
                if (activeItem) {
                    activeItem.style.transition = '';
                }
            }, 300);
            
            isSwiping = false;
            activeItem = null;
        }
        
        // è§¦æ‘¸å–æ¶ˆäº‹ä»¶
        function handleListTouchCancel(e) {
            if (!isSwiping || !activeItem) return;
            
            // é‡ç½®æ ·å¼
            activeItem.style.transition = 'transform 0.3s, background-color 0.3s';
            activeItem.style.transform = 'translateX(0)';
            activeItem.style.backgroundColor = '';
            
            setTimeout(() => {
                if (activeItem) {
                    activeItem.style.transition = '';
                }
            }, 300);
            
            isSwiping = false;
            activeItem = null;
        }

        // æ‰“å¼€åœ°ç‚¹æ‰¹é‡ç¼–è¾‘å™¨
        function openLocationEditor(locationIndex) {
            // ç¡®ä¿è¯¥ç´¢å¼•å­˜åœ¨ä¸”æ˜¯åœ°ç‚¹è¡Œ
            if (!items[locationIndex] || !items[locationIndex].startsWith('@')) {
                return;
            }
            
            // æ”¶é›†å½“å‰åœ°ç‚¹åŠå…¶æ‰€æœ‰èµ„äº§
            const locationData = [items[locationIndex]];
            let nextIndex = locationIndex + 1;
            
            // æ‰¾å‡ºæ‰€æœ‰å±äºè¯¥åœ°ç‚¹çš„èµ„äº§
            while (nextIndex < items.length && !items[nextIndex].startsWith('@')) {
                locationData.push(items[nextIndex]);
                nextIndex++;
            }
            
            // å¡«å……ç¼–è¾‘æ¡†å†…å®¹
            locationEditInput.value = locationData.join('\n');
            
            // è®°å½•å½“å‰ç¼–è¾‘çš„åœ°ç‚¹ç´¢å¼•
            currentLocationEditIndex = locationIndex;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            locationEditModal.style.display = 'block';
            overlay.style.display = 'block';
            
            // å°†å…‰æ ‡æ”¾åœ¨æ–‡æœ¬æ¡†æœ«å°¾ï¼Œè€Œä¸æ˜¯é€‰ä¸­å…¨éƒ¨æ–‡æœ¬
            setTimeout(() => {
                locationEditInput.focus();
                locationEditInput.selectionStart = locationEditInput.value.length;
                locationEditInput.selectionEnd = locationEditInput.value.length;
            }, 100);
        }

        // ä¿å­˜åœ°ç‚¹æ‰¹é‡ç¼–è¾‘
        function saveLocationEdit() {
            const editedText = locationEditInput.value.trim();
            if (!editedText) {
                showErrorToast('å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            // å¤„ç†è¿ç»­ç©ºæ ¼
            const editedItems = editedText.split('\n')
                .filter(item => item.trim())
                .map(item => normalizeSpaces(item.trim()));
            
            if (editedItems.length === 0) {
                showErrorToast('å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            // æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦æ˜¯@å¼€å¤´
            if (!editedItems[0].startsWith('@')) {
                showErrorToast('ç¬¬ä¸€è¡Œå¿…é¡»æ˜¯åœ°ç‚¹è¡Œï¼ˆä»¥@å¼€å¤´ï¼‰');
                return;
            }
            
            // å¼€å§‹äº‹åŠ¡
            const transaction = db.transaction(['items'], 'readwrite');
            const store = transaction.objectStore('items');
            
            // å…ˆè·å–æ‰€æœ‰æ•°æ®
            const getAllRequest = store.getAll();
            
            getAllRequest.onsuccess = () => {
                const allDBItems = getAllRequest.result;
                const allItems = [];
                
                // æ­£ç¡®å¤„ç†æ•°æ®æ ¼å¼
                for (const item of allDBItems) {
                    if (item.value !== undefined) {
                        allItems.push(item.value);
                    } else {
                        console.error('æ‰¾åˆ°å¼‚å¸¸æ•°æ®é¡¹ï¼Œæ²¡æœ‰valueå­—æ®µ:', item);
                    }
                }
                
                // æ‰¾å‡ºå½“å‰åœ°ç‚¹åŠå…¶èµ„äº§åœ¨æ•°æ®åº“ä¸­çš„èŒƒå›´
                let startIndex = currentLocationEditIndex;
                let endIndex = startIndex + 1;
                
                while (endIndex < allItems.length && !allItems[endIndex].startsWith('@')) {
                    endIndex++;
                }
                
                // è®¡ç®—è¦åˆ é™¤çš„é¡¹ç›®æ•°
                const deleteCount = endIndex - startIndex;
                
                console.log(`ç¼–è¾‘åœ°ç‚¹ä½ç½®: ${startIndex} åˆ° ${endIndex}, å…± ${deleteCount} é¡¹`);
                console.log('ç¼–è¾‘å‰æ•°æ®:', allItems.slice(startIndex, endIndex));
                console.log('ç¼–è¾‘åæ•°æ®:', editedItems);
                
                // æ¸…é™¤storeåé‡æ–°æ·»åŠ æ•°æ®
                store.clear().onsuccess = () => {
                    try {
                        let addedCount = 0;
                        let errorCount = 0;
                        
                        // æ·»åŠ ç¼–è¾‘å‰çš„æ•°æ®
                        for (let i = 0; i < startIndex; i++) {
                            try {
                                store.add({ value: allItems[i] });
                                addedCount++;
                            } catch(e) {
                                console.error(`æ·»åŠ ç¼–è¾‘å‰æ•°æ®å‡ºé”™ [${i}]:`, e);
                                errorCount++;
                            }
                        }
                        
                        // æ·»åŠ ç¼–è¾‘åçš„æ•°æ®
                        for (let i = 0; i < editedItems.length; i++) {
                            try {
                                store.add({ value: editedItems[i] });
                                addedCount++;
                            } catch(e) {
                                console.error(`æ·»åŠ ç¼–è¾‘åæ•°æ®å‡ºé”™ [${i}]:`, e);
                                errorCount++;
                            }
                        }
                        
                        // æ·»åŠ ç¼–è¾‘åçš„å‰©ä½™æ•°æ®
                        for (let i = endIndex; i < allItems.length; i++) {
                            try {
                                store.add({ value: allItems[i] });
                                addedCount++;
                            } catch(e) {
                                console.error(`æ·»åŠ å‰©ä½™æ•°æ®å‡ºé”™ [${i}]:`, e);
                                errorCount++;
                            }
                        }
                        
                        console.log(`æ•°æ®å¤„ç†å®Œæˆ: æˆåŠŸ ${addedCount} é¡¹, å¤±è´¥ ${errorCount} é¡¹`);
                        
                        transaction.oncomplete = () => {
                            loadItems();
                            locationEditModal.style.display = 'none';
                            overlay.style.display = 'none';
                            showToast('åœ°ç‚¹åŠå…¶èµ„äº§å·²æ›´æ–°');
                        };
                        
                        transaction.onerror = (event) => {
                            console.error('ä¿å­˜åœ°ç‚¹ç¼–è¾‘äº‹åŠ¡å‡ºé”™:', event);
                            showErrorToast('ä¿å­˜å¤±è´¥: ' + (event.target.error?.message || 'æ•°æ®åº“é”™è¯¯'));
                        };
                    } catch(error) {
                        console.error('æ‰¹é‡ä¿å­˜åœ°ç‚¹ç¼–è¾‘å‡ºé”™:', error);
                        showErrorToast('ä¿å­˜å¤±è´¥: ' + error.message);
                    }
                };
            };
        }

        // æ·»åŠ å¤„ç†è¿ç»­ç©ºæ ¼çš„å‡½æ•°
        function normalizeSpaces(text) {
            return text.replace(/\s{2,}/g, ' ');
        }

        // ä¿®æ”¹æœç´¢å‡½æ•°ï¼Œæ’é™¤æ¨¡æ¿èµ„äº§
        function searchAssets(keyword) {
            if (!keyword.trim()) {
                searchResults.innerHTML = '<div class="search-count">è¯·è¾“å…¥æœç´¢å…³é”®è¯</div>';
                return;
            }

            let results = [];
            let currentLocation = null;
            let totalCount = 0;
            let firstLocationIndex = -1;
            let isFirstLocation = true;

            items.forEach((item, index) => {
                if (item.startsWith('@')) {
                    currentLocation = item;
                    
                    // è®°å½•ç¬¬ä¸€ä¸ªåœ°ç‚¹çš„ç´¢å¼•
                    if (isFirstLocation) {
                        firstLocationIndex = index;
                        isFirstLocation = false;
                    }
                } else if (item.toLowerCase().includes(keyword.toLowerCase())) {
                    // æ’é™¤ç¬¬ä¸€ä¸ªåœ°ç‚¹ï¼ˆæ¨¡æ¿èµ„äº§ï¼‰ä¸‹çš„èµ„äº§
                    const belongsToFirstLocation = (
                        firstLocationIndex !== -1 && 
                        currentLocation === items[firstLocationIndex]
                    );
                    
                    if (!belongsToFirstLocation) {
                        results.push({
                            location: currentLocation,
                            asset: item
                        });
                        totalCount++;
                    }
                }
            });

            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-count">æœªæ‰¾åˆ°ç›¸å…³èµ„äº§</div>';
                return;
            }

            // æŒ‰åœ°ç‚¹åˆ†ç»„æ˜¾ç¤ºç»“æœ
            let html = `<div class="search-count">æ‰¾åˆ° ${totalCount} ä¸ªç›¸å…³èµ„äº§</div>`;
            let currentDisplayLocation = null;

            results.forEach(result => {
                if (currentDisplayLocation !== result.location) {
                    if (currentDisplayLocation) {
                        html += '</div>';
                    }
                    currentDisplayLocation = result.location;
                    html += `
                        <div class="search-result-item">
                            <div class="search-result-location">${result.location}</div>
                    `;
                }
                html += `<div class="search-result-asset">${result.asset}</div>`;
            });
            html += '</div>';

            searchResults.innerHTML = html;
        }

        // ä¿®æ”¹å¤åˆ¶åˆ°å‰ªè´´æ¿çš„è¾…åŠ©å‡½æ•°ï¼Œä¸å¤åˆ¶ç¼–å·
        function copyToClipboard(text) {
            // å»é™¤æ–‡æœ¬ä¸­çš„æŠ˜å å›¾æ ‡ç¬¦å·
            text = text.replace(/[â–¼â–¶]/g, '').trim();
            
            // ç§»é™¤èµ„äº§ç¼–å· (å¦‚ "1. ", "2. " ç­‰)
            text = text.replace(/^\d+\.\s+/g, '');
            
            // åˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            
            // é€‰æ‹©å¹¶å¤åˆ¶
            textarea.select();
            document.execCommand('copy');
            
            // æ¸…ç†
            document.body.removeChild(textarea);
        }

        // ä¿®æ”¹æ˜¾ç¤ºæ™ºèƒ½æç¤ºå‡½æ•°ï¼Œä»ä¸€å¼€å§‹å°±å°†å»ºè®®é¡¹å€’åºæ˜¾ç¤º
        function showSuggestions(text) {
            text = text.trim();
            if (!text) {
                suggestions.style.display = 'none';
                return;
            }

            // é¦–å…ˆå°†æ•´ä¸ªåˆ—è¡¨å€’åºå¤„ç†ï¼Œç¡®ä¿æœ€æ–°æ·»åŠ çš„é¡¹ç›®æ’åœ¨å‰é¢
            const reversedItems = [...items].reverse();
            const uniqueItems = [...new Set(reversedItems)];
            
            const filtered = uniqueItems.filter(item => 
                item.toLowerCase().includes(text.toLowerCase())
            );
            
            if (filtered.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            suggestions.innerHTML = filtered.map(item => 
                `<div class="suggestion-item">${item}</div>`
            ).join('');
            
            suggestions.style.display = 'block';

            // ä¿®æ”¹å»ºè®®é¡¹ç‚¹å‡»äº‹ä»¶ç›‘å¬
            const suggestionItems = document.querySelectorAll('.suggestion-item');
            suggestionItems.forEach(item => {
                item.addEventListener('click', () => {
                    itemInput.value = item.textContent;
                    suggestions.style.display = 'none';
                    itemInput.focus(); // ä¿æŒè¾“å…¥æ¡†ç„¦ç‚¹
                });
            });
        }

        // æ·»åŠ ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æ™ºèƒ½æç¤º
        document.addEventListener('click', (e) => {
            if (!suggestions.contains(e.target) && e.target !== itemInput) {
                suggestions.style.display = 'none';
            }
        });

        // è¾“å…¥äº‹ä»¶å¤„ç†
        itemInput.addEventListener('input', (e) => {
            showSuggestions(e.target.value);
        });

        // æ·»åŠ æ»šåŠ¨åˆ°åº•éƒ¨çš„å‡½æ•°
        function scrollToBottom() {
            dataList.scrollTop = dataList.scrollHeight;
        }

        // æ·»åŠ æç¤ºå‡½æ•°
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(40, 167, 69, 0.9);
                color: white;
                padding: 10px 20px;
                border-radius: 4px;
                z-index: 1000;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            // 2ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s';
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 2000);
        }

        // ä¿®æ”¹æ£€æŸ¥@å¼€å¤´è¡Œæ˜¯å¦é‡å¤çš„å‡½æ•°ï¼Œä½¿å…¶æ›´ä¸¥è°¨
        function checkDuplicateLocation(newItem) {
            if (!newItem.startsWith('@')) {
                return false;
            }
            
            // è·å–æ–°è¾“å…¥çš„åœ°ç‚¹åç§°ï¼ˆ@ååˆ°ç¬¬ä¸€ä¸ªç©ºæ ¼ä¹‹å‰çš„å†…å®¹ï¼‰
            const newLocation = newItem.substring(1, newItem.indexOf(' ') > 0 ? newItem.indexOf(' ') : newItem.length);
            
            // æ£€æŸ¥ç°æœ‰é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨ç›¸åŒåœ°ç‚¹åç§°
            return items.some(item => {
                if (item.startsWith('@')) {
                    const existingLocation = item.substring(1, item.indexOf(' ') > 0 ? item.indexOf(' ') : item.length);
                    return existingLocation === newLocation;
                }
                return false;
            });
        }

        // ä¿®æ”¹æ·»åŠ æ–°é¡¹ç›®çš„å‡½æ•°
        function addNewItem() {
            let newItem = itemInput.value.trim();
            if (newItem) {
                try {
                    // å¤„ç†è¿ç»­ç©ºæ ¼
                    newItem = normalizeSpaces(newItem);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯é‡å¤çš„@å¼€å¤´è¡Œ
                    if (checkDuplicateLocation(newItem)) {
                        showErrorToast('è¯¥åœ°ç‚¹å·²å­˜åœ¨ï¼Œè¯·å‹¿é‡å¤æ·»åŠ ï¼');
                        return;
                    }
                    
                    console.log('æ·»åŠ æ–°é¡¹ç›®:', newItem);
                    saveItem(newItem);
                    itemInput.value = '';
                    suggestions.style.display = 'none';
                    itemInput.focus();
                    
                    // å»¶è¿Ÿä¸€ç‚¹æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ
                    setTimeout(() => {
                        scrollToBottom();
                        showToast('æ·»åŠ æˆåŠŸï¼');
                    }, 200);
                } catch (error) {
                    console.error('æ·»åŠ æ–°é¡¹ç›®æ—¶å‡ºé”™:', error);
                    showErrorToast('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        // ä¿®æ”¹å¯¼å‡ºTXTæ–‡ä»¶çš„å‡½æ•°
        function exportToTxt() {
            if (items.length === 0) {
                showErrorToast('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }

            // æ‰¾åˆ°ç¬¬äºŒä¸ª@å¼€å¤´çš„è¡Œçš„ç´¢å¼•
            let startIndex = -1;
            let foundFirst = false;
            for (let i = 0; i < items.length; i++) {
                if (items[i].startsWith('@')) {
                    if (!foundFirst) {
                        foundFirst = true;
                    } else {
                        startIndex = i;
                        break;
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¬¬äºŒä¸ª@è¡Œï¼Œè¯´æ˜åªæœ‰æ¨¡æ¿æ•°æ®
            if (startIndex === -1) {
                showErrorToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼');
                return;
            }

            // åªå¯¼å‡ºä»ç¬¬äºŒä¸ª@è¡Œå¼€å§‹çš„æ•°æ®ï¼Œå¹¶å¤„ç†è¿ç»­ç©ºæ ¼
            const exportItems = items.slice(startIndex).map(item => normalizeSpaces(item));
            const content = exportItems.join('\n');
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'æ•°æ®è¡¨.txt';
            document.body.appendChild(link);
            link.click();
            
            // æ¸…ç†
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('å¯¼å‡ºæˆåŠŸï¼');
        }

        // å¯¼å‡ºTXTåŠŸèƒ½
        exportButton.addEventListener('click', exportToTxt);

        // ä¿®æ”¹æ˜¾ç¤ºé”™è¯¯æç¤ºçš„å‡½æ•°
        function showErrorToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(220, 53, 69, 0.9);
                color: white;
                padding: 10px 20px;
                border-radius: 4px;
                z-index: 1000;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s';
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 3000);
        }

        // ä¼˜åŒ–æ‰¹é‡ä¿®æ”¹å‡½æ•°
        const bulkUpdateItems = (values) => {
            return new Promise((resolve) => {
                const transaction = db.transaction(['items'], 'readwrite');
                const store = transaction.objectStore('items');
                
                // æ£€æŸ¥æ–°æ•°æ®ä¸­çš„åœ°ç‚¹æ˜¯å¦æœ‰é‡å¤
                const newLocations = new Set();
                const duplicateLocations = [];
                
                // å¤„ç†è¾“å…¥å€¼ï¼Œæ›¿æ¢è¿ç»­ç©ºæ ¼
                const processedValues = values.map(value => normalizeSpaces(value.trim()));
                
                // æ£€æŸ¥æ–°æ•°æ®ä¸­çš„åœ°ç‚¹é‡å¤
                for (const value of processedValues) {
                    if (value.startsWith('@')) {
                        const location = value.substring(1, value.indexOf(' ') > 0 ? value.indexOf(' ') : value.length);
                        
                        // æ£€æŸ¥æ–°æ•°æ®å†…éƒ¨æ˜¯å¦æœ‰é‡å¤
                        if (newLocations.has(location)) {
                            duplicateLocations.push(location);
                            continue;
                        }
                        
                        newLocations.add(location);
                    }
                }
                
                // å¦‚æœæœ‰é‡å¤åœ°ç‚¹ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä½†ä¸å…³é—­æ¨¡æ€æ¡†
                if (duplicateLocations.length > 0) {
                    showErrorToast(`å‘ç°é‡å¤åœ°ç‚¹: "${duplicateLocations.join('", "')}"ï¼Œè¯·ä¿®æ­£åé‡è¯•`);
                    resolve(false); // è¿”å›falseè¡¨ç¤ºæœ‰é”™è¯¯
                    return;
                }
                
                // æ˜¾ç¤ºå¤„ç†ä¸­æç¤º
                showToast('æ­£åœ¨å¤„ç†æ•°æ®...');
                
                // æ²¡æœ‰é‡å¤åœ°ç‚¹ï¼Œæ‰§è¡Œä¿®æ”¹
            store.clear().onsuccess = () => {
                let addedCount = 0;
                const addItems = processedValues.map(value => {
                    return new Promise((resolve) => {
                        if (value) {
                            const request = store.add({ value: value });
                            request.onsuccess = () => {
                                addedCount++;
                                resolve();
                            };
                            request.onerror = () => {
                                console.error('æ·»åŠ æ•°æ®å¤±è´¥:', value);
                                resolve();
                            };
                        } else {
                            resolve();
                        }
                    });
                });
                
                Promise.all(addItems).then(() => {
                    transaction.oncomplete = () => {
                        loadItems();
                        showToast(`æ‰¹é‡ä¿®æ”¹æˆåŠŸï¼Œå…±æ›´æ–°${addedCount}æ¡æ•°æ®ï¼`);
                    };
                });
            };
            return true; // è¿”å›trueè¡¨ç¤ºæˆåŠŸ
        })
    }

        // ä¿®æ”¹æ‰¹é‡ç¼–è¾‘æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        batchEditButton.addEventListener('click', () => {
            editAllModal.style.display = 'block';
            overlay.style.display = 'block';
            // å°†å½“å‰æ•°æ®å¡«å……åˆ°æ–‡æœ¬æ¡†ä¸­
            editAllInput.value = items.join('\n');
            
            // å°†æ–‡æœ¬æ¡†æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                editAllInput.scrollTop = editAllInput.scrollHeight;
            }, 100);
        });

        // ä¿®æ”¹ä¿å­˜æ‰¹é‡ä¿®æ”¹çš„ç‚¹å‡»äº‹ä»¶
        saveEditAllButton.addEventListener('click', () => {
            const editAllText = editAllInput.value;
            const editAllItems = editAllText.split('\n').filter(item => item.trim());
            
            if (editAllItems.length === 0) {
                showErrorToast('è¯·è¾“å…¥è¦ä¿®æ”¹çš„æ•°æ®ï¼');
                return;
            }
            
            if (bulkUpdateItems(editAllItems)) {
                editAllModal.style.display = 'none';
                overlay.style.display = 'none';
                editAllInput.value = '';
            }
        });

        // ä¿®æ”¹ä¿å­˜ç¼–è¾‘çš„äº‹ä»¶å¤„ç†
        saveEditButton.addEventListener('click', () => {
            let newItem = editInput.value.trim();
            if (newItem) {
                // å¤„ç†è¿ç»­ç©ºæ ¼
                newItem = normalizeSpaces(newItem);
                updateItem(currentEditIndex, newItem);
                editInput.value = '';
                editModal.style.display = 'none';
                overlay.style.display = 'none';
            }
        });

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        overlay.addEventListener('click', () => {
            editModal.style.display = 'none';
            importModal.style.display = 'none';
            editAllModal.style.display = 'none';
            guideModal.style.display = 'none';
            searchModal.style.display = 'none';
            locationEditModal.style.display = 'none';
            overlay.style.display = 'none';
        });

        // ä¼˜åŒ–æ‰¹é‡æ·»åŠ å‡½æ•°
        const bulkSaveItems = (values) => {
            return new Promise((resolve) => {
                const transaction = db.transaction(['items'], 'readwrite');
                const store = transaction.objectStore('items');
                
                // å…ˆè·å–æ‰€æœ‰ç°æœ‰æ•°æ®æ¥æ£€æŸ¥åœ°ç‚¹æ˜¯å¦é‡å¤
                const getAllRequest = store.getAll();
                
                getAllRequest.onsuccess = () => {
                    const existingItems = getAllRequest.result.map(item => item.value);
                    const existingLocations = new Set();
                    const newLocations = new Set();
                    const duplicateLocations = [];
                    
                    // å¤„ç†è¾“å…¥å€¼ï¼Œæ›¿æ¢è¿ç»­ç©ºæ ¼
                    const processedValues = values.map(value => normalizeSpaces(value.trim()));
                    
                    // æ”¶é›†ç°æœ‰çš„åœ°ç‚¹
                    existingItems.forEach(item => {
                        if (item.startsWith('@')) {
                            const location = item.substring(1, item.indexOf(' ') > 0 ? item.indexOf(' ') : item.length);
                            existingLocations.add(location);
                        }
                    });
                    
                    // æ£€æŸ¥æ–°æ•°æ®ä¸­çš„åœ°ç‚¹æ˜¯å¦æœ‰é‡å¤
                    for (const value of processedValues) {
                        if (value.startsWith('@')) {
                            const location = value.substring(1, value.indexOf(' ') > 0 ? value.indexOf(' ') : value.length);
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰åœ°ç‚¹é‡å¤
                            if (existingLocations.has(location)) {
                                duplicateLocations.push(`${location}(å·²å­˜åœ¨)`);
                                continue;
                            }
                            
                            // æ£€æŸ¥æ–°æ•°æ®å†…éƒ¨æ˜¯å¦æœ‰é‡å¤
                            if (newLocations.has(location)) {
                                duplicateLocations.push(`${location}(é‡å¤)`);
                                continue;
                            }
                            
                            newLocations.add(location);
                        }
                    }
                    
                    // å¦‚æœæœ‰é‡å¤åœ°ç‚¹ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä½†ä¸å…³é—­æ¨¡æ€æ¡†
                    if (duplicateLocations.length > 0) {
                        showErrorToast(`å‘ç°é‡å¤åœ°ç‚¹: "${duplicateLocations.join('", "')}"ï¼Œè¯·ä¿®æ­£åé‡è¯•`);
                        resolve(false);
                        return;
                    }
                    
                    // æ˜¾ç¤ºå¤„ç†ä¸­æç¤º
                    showToast('æ­£åœ¨å¯¼å…¥æ•°æ®...');
                    
                    // æ²¡æœ‰é‡å¤åœ°ç‚¹ï¼Œæ‰§è¡Œå¯¼å…¥
                    let addedCount = 0;
                    const addItems = processedValues.map(value => {
                        return new Promise((resolve) => {
                if (value) {
                                const request = store.add({ value: value });
                                request.onsuccess = () => {
                                    addedCount++;
                                    resolve();
                                };
                                request.onerror = () => {
                                    console.error('æ·»åŠ æ•°æ®å¤±è´¥:', value);
                                    resolve();
                                };
                            } else {
                                resolve();
                            }
                        });
                    });
                    
                    Promise.all(addItems).then(() => {
            transaction.oncomplete = () => {
                loadItems();
                            showToast(`æ‰¹é‡æ·»åŠ æˆåŠŸï¼Œå…±æ·»åŠ ${addedCount}æ¡æ•°æ®ï¼`);
                            resolve(true);  // æ“ä½œæˆåŠŸå®Œæˆ
            };
                    });
                };
            });
        };

        // æ‰¹é‡æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        batchAddButton.addEventListener('click', () => {
            importModal.style.display = 'block';
            overlay.style.display = 'block';
            importInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        });

        // ç¡®è®¤æ‰¹é‡æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        savebatchAddButton.addEventListener('click', async () => {  // æ·»åŠ async
            const importText = importInput.value;
            const importItems = importText.split('\n').filter(item => item.trim());
            
            if (importItems.length === 0) {
                showErrorToast('è¯·è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®ï¼');
                return;
            }
            
            const success = await bulkSaveItems(importItems);  // ç­‰å¾…æ“ä½œå®Œæˆ
            if (success) {
            importModal.style.display = 'none';
            overlay.style.display = 'none';
            importInput.value = '';
            setTimeout(() => {
                scrollToBottom();
            }, 100);
            }
        });

        // ä¿®æ”¹ overlay ç‚¹å‡»äº‹ä»¶ï¼Œæ·»åŠ å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†çš„é€»è¾‘
        overlay.addEventListener('click', () => {
            editModal.style.display = 'none';
            importModal.style.display = 'none';
            editAllModal.style.display = 'none';
            guideModal.style.display = 'none';
            searchModal.style.display = 'none';
            backupModal.style.display = 'none';
            locationEditModal.style.display = 'none';
            overlay.style.display = 'none';
        });

        // ä¿®æ”¹åˆ é™¤å…¨éƒ¨æ•°æ®çš„å‡½æ•°
        const deleteAllItems = () => {
            // æ‰¾åˆ°ç¬¬äºŒä¸ª@å¼€å¤´çš„è¡Œçš„ç´¢å¼•
            let startIndex = -1;
            let foundFirst = false;
            for (let i = 0; i < items.length; i++) {
                if (items[i].startsWith('@')) {
                    if (!foundFirst) {
                        foundFirst = true;
                    } else {
                        startIndex = i;
                        break;
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¬¬äºŒä¸ª@è¡Œï¼Œè¯´æ˜åªæœ‰æ¨¡æ¿æ•°æ®
            if (startIndex === -1) {
                showErrorToast('æ²¡æœ‰å¯åˆ é™¤çš„æ•°æ®ï¼');
                return;
            }

            const transaction = db.transaction(['items'], 'readwrite');
            const store = transaction.objectStore('items');
            
            // å…ˆè·å–æ‰€æœ‰æ•°æ®
            const getAllRequest = store.getAll();
            
            getAllRequest.onsuccess = () => {
                // æ¸…ç©ºæ‰€æœ‰æ•°æ®
                store.clear().onsuccess = () => {
                    // é‡æ–°æ·»åŠ æ¨¡æ¿æ•°æ®ï¼ˆç¬¬ä¸€ä¸ªåœ°ç‚¹åŠå…¶èµ„äº§ï¼‰
                    const templateItems = items.slice(0, startIndex);
                    
                    templateItems.forEach(value => {
                        store.add({ value });
                    });
                    
                    transaction.oncomplete = () => {
                loadItems();
                        showToast('åˆ é™¤æˆåŠŸï¼');
                    };
                };
            };
        };

        // ä¿®æ”¹åˆ é™¤å…¨éƒ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        deleteAllButton.addEventListener('click', () => {
            // æ‰¾åˆ°ç¬¬äºŒä¸ª@å¼€å¤´çš„è¡Œçš„ç´¢å¼•
            let startIndex = -1;
            let foundFirst = false;
            for (let i = 0; i < items.length; i++) {
                if (items[i].startsWith('@')) {
                    if (!foundFirst) {
                        foundFirst = true;
                    } else {
                        startIndex = i;
                        break;
                    }
                }
            }
            
            if (startIndex === -1) {
                showErrorToast('æ²¡æœ‰å¯åˆ é™¤çš„æ•°æ®ï¼');
                return;
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿï¼ˆæ¨¡æ¿èµ„äº§å°†ä¿ç•™ï¼‰æ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                deleteAllItems();
            }
        });

        // æ·»åŠ å…³é—­æŒ‡å—æŒ‰é’®äº‹ä»¶
        closeGuideButton.addEventListener('click', () => {
            guideModal.style.display = 'none';
            overlay.style.display = 'none';
        });

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬ï¼Œæ”¯æŒ ESC é”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                editModal.style.display = 'none';
                importModal.style.display = 'none';
                editAllModal.style.display = 'none';
                guideModal.style.display = 'none';
                searchModal.style.display = 'none';
                locationEditModal.style.display = 'none';
                overlay.style.display = 'none';
            }
        });

        // æ·»åŠ ä¸€é”®æŠ˜å /å±•å¼€å‡½æ•°
        function toggleAllLocations() {
            try {
                const locationItems = document.querySelectorAll('.location-item');
                if (locationItems.length === 0) {
                    console.log('æœªæ‰¾åˆ°åœ°ç‚¹è¡Œï¼Œæ— æ³•æ‰§è¡ŒæŠ˜å /å±•å¼€æ“ä½œ');
                    return;
                }
                
                isAllCollapsed = !isAllCollapsed;
                console.log(`æ‰§è¡Œ${isAllCollapsed ? 'æŠ˜å ' : 'å±•å¼€'}æ‰€æœ‰åœ°ç‚¹æ“ä½œ`);
                
                locationItems.forEach(item => {
                    // è·³è¿‡ç¬¬ä¸€ä¸ªåœ°ç‚¹ï¼ˆæ¨¡æ¿èµ„äº§ï¼‰
                    if (item.getAttribute('data-location-index') === '0') {
                        return;
                    }
                    
                    const locationIndex = item.getAttribute('data-location-index');
                    const assets = document.querySelectorAll(`[data-belongs-to="${locationIndex}"]`);
                    const collapseIcon = item.querySelector('.collapse-icon');
                    
                    if (assets.length > 0) {
                        assets.forEach(asset => {
                            asset.style.display = isAllCollapsed ? 'none' : 'flex';
                        });
                        collapseIcon.textContent = isAllCollapsed ? 'â–¶' : 'â–¼';
                    }
                });
                
                // æ›´æ–°æŒ‰é’®å›¾æ ‡
                collapseAllButton.textContent = isAllCollapsed ? 'â–¶' : 'â–¼';
            } catch (error) {
                console.error('æŠ˜å /å±•å¼€æ‰€æœ‰åœ°ç‚¹æ—¶å‡ºé”™:', error);
            }
        }

        // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        collapseAllButton.addEventListener('click', toggleAllLocations);

        // æ³¨é‡Šæ‰è¿™é‡Œçš„åˆå§‹åŒ–ï¼Œä»…åœ¨DOMContentLoadedäº‹ä»¶ä¸­åˆå§‹åŒ–ä¸€æ¬¡
        // initDB();
        // refreshList();
        
        // æ·»åŠ å®šæœŸå†…å­˜æ¸…ç†
        setInterval(() => {
            if (appSettings.autoReleaseMemory && items.length > 500) {
                console.log('æ‰§è¡Œå®šæœŸå†…å­˜æ¸…ç†...');
                nodeCache = {}; // æ¸…ç©ºèŠ‚ç‚¹ç¼“å­˜
                
                // å°è¯•è§¦å‘åƒåœ¾å›æ”¶
                if (perfMonitor.enabled && perfMonitor.memoryUsage.length > 0) {
                    const latestMemory = perfMonitor.memoryUsage[perfMonitor.memoryUsage.length - 1];
                    if (latestMemory.used > 200) { // å¦‚æœå†…å­˜ä½¿ç”¨è¶…è¿‡200MB
                        perfMonitor.releaseResources();
                    }
                }
            }
        }, 60000); // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡

        // ä¿®æ”¹é”®ç›˜äº‹ä»¶æ”¯æŒ
        itemInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const newItem = itemInput.value.trim();
                if (newItem) {
                    addNewItem();
                }
            }
        });

        editInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                saveEditButton.click();
            }
        });

        // æ·»åŠ ä¿å­˜æŒ‰é’®äº‹ä»¶ç›‘å¬
        saveLocationEditButton.addEventListener('click', saveLocationEdit);

        // æ·»åŠ æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        searchButton.addEventListener('click', () => {
            searchModal.style.display = 'block';
            overlay.style.display = 'block';
            searchInput.value = '';
            searchInput.focus();
            searchResults.innerHTML = '<div class="search-count">è¯·è¾“å…¥æœç´¢å…³é”®è¯</div>';
        });

        // æ·»åŠ æœç´¢è¾“å…¥æ¡†äº‹ä»¶ï¼ˆå®æ—¶æœç´¢ï¼‰
        searchInput.addEventListener('input', (e) => {
            searchAssets(e.target.value);
        });

        // æ·»åŠ å…³é—­æœç´¢æŒ‰é’®äº‹ä»¶
        closeSearchButton.addEventListener('click', () => {
            searchModal.style.display = 'none';
            overlay.style.display = 'none';
        });

        // æ·»åŠ æ€§èƒ½ç›‘æ§åŠŸèƒ½
        let perfMonitor = {
            lastRefreshTime: 0,
            frameCount: 0,
            memoryUsage: [],
            enabled: false,
            
            // åˆå§‹åŒ–æ€§èƒ½ç›‘æ§
            init() {
                this.lastRefreshTime = performance.now();
                this.frameCount = 0;
                this.memoryUsage = [];
                this.enabled = false;
            },
            
            // è®°å½•æ€§èƒ½æ•°æ®
            record() {
                if (!this.enabled) return;
                
                this.frameCount++;
                const currentTime = performance.now();
                
                // æ¯ç§’è®°å½•ä¸€æ¬¡
                if (currentTime - this.lastRefreshTime >= 1000) {
                    const fps = Math.round(this.frameCount * 1000 / (currentTime - this.lastRefreshTime));
                    console.log(`æ€§èƒ½ç›‘æ§: FPS = ${fps}`);
                    
                    // è®°å½•å†…å­˜ä½¿ç”¨æƒ…å†µ(å¦‚æœæµè§ˆå™¨æ”¯æŒ)
                    if (window.performance && window.performance.memory) {
                        const memory = window.performance.memory;
                        const memoryUsed = Math.round(memory.usedJSHeapSize / (1024 * 1024));
                        const memoryTotal = Math.round(memory.totalJSHeapSize / (1024 * 1024));
                        console.log(`å†…å­˜ä½¿ç”¨: ${memoryUsed}MB / ${memoryTotal}MB`);
                        
                        this.memoryUsage.push({
                            time: new Date(),
                            used: memoryUsed,
                            total: memoryTotal
                        });
                        
                        // åªä¿ç•™æœ€è¿‘10æ¬¡è®°å½•
                        if (this.memoryUsage.length > 10) {
                            this.memoryUsage.shift();
                        }
                    }
                    
                    this.frameCount = 0;
                    this.lastRefreshTime = currentTime;
                    
                    // å¦‚æœå†…å­˜å ç”¨è¿‡é«˜ï¼Œå°è¯•å›æ”¶ä¸€äº›èµ„æº
                    this.checkMemory();
                }
                
                // è¯·æ±‚ä¸‹ä¸€å¸§è®°å½•
                requestAnimationFrame(() => this.record());
            },
            
            // æ£€æŸ¥å†…å­˜å ç”¨å¹¶å°è¯•é‡Šæ”¾
            checkMemory() {
                if (this.memoryUsage.length < 2) return;
                
                const latest = this.memoryUsage[this.memoryUsage.length - 1];
                const previous = this.memoryUsage[this.memoryUsage.length - 2];
                
                // å¦‚æœå†…å­˜å¢é•¿è¶…è¿‡20%ï¼Œå°è¯•é‡Šæ”¾ä¸€äº›èµ„æº
                if (latest.used > previous.used * 1.2 && latest.used > 200) {
                    console.log('æ£€æµ‹åˆ°å†…å­˜ä½¿ç”¨é‡å¤§å¹…å¢åŠ ï¼Œå°è¯•ä¼˜åŒ–...');
                    this.releaseResources();
                }
            },
            
            // é‡Šæ”¾ä¸€äº›ä¸å¿…è¦çš„èµ„æº
            releaseResources() {
                // æ¸…é™¤ä¸€äº›ä¸å¿…è¦çš„DOMå¼•ç”¨
                nodeCache = {};
                
                // é‡Šæ”¾é—²ç½®çš„äº‹ä»¶ç›‘å¬å™¨
                if (dataList.children.length > 500) {
                    setupEventDelegation();
                }
                
                // å¼ºåˆ¶åƒåœ¾å›æ”¶(è™½ç„¶ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œä½†å¯ä»¥å°è¯•é‡Šæ”¾ä¸€äº›å˜é‡)
                const largeArray = [];
                // åˆ›å»ºå¤§å‹å¯¹è±¡ç„¶åç«‹å³é‡Šæ”¾ï¼Œå¯èƒ½è§¦å‘GC
                for (let i = 0; i < 10000; i++) {
                    largeArray.push(new Array(10000).fill(0));
                }
                largeArray.length = 0;
            },
            
            // å¯ç”¨æ€§èƒ½ç›‘æ§
            enable() {
                this.enabled = true;
                this.record();
                console.log('æ€§èƒ½ç›‘æ§å·²å¯ç”¨');
            },
            
            // åœç”¨æ€§èƒ½ç›‘æ§
            disable() {
                this.enabled = false;
                console.log('æ€§èƒ½ç›‘æ§å·²åœç”¨');
            }
        };
        
        // ç¼“å­˜DOMèŠ‚ç‚¹å¼•ç”¨
        let nodeCache = {};
        
        // è·å–DOMèŠ‚ç‚¹çš„è¾…åŠ©å‡½æ•°(å¸¦ç¼“å­˜)
        function getNode(selector) {
            if (!nodeCache[selector]) {
                nodeCache[selector] = document.querySelector(selector);
            }
            return nodeCache[selector];
        }
        
        // é’ˆå¯¹å¤§å‹æ•°æ®çš„ä¼˜åŒ–è®¾ç½®
        let appSettings = {
            usePagination: false,      // æ˜¯å¦ä½¿ç”¨åˆ†é¡µè€Œä¸æ˜¯æ— é™æ»šåŠ¨
            pageSize: 200,             // æ¯é¡µæ˜¾ç¤ºçš„é¡¹ç›®æ•°é‡
            currentPage: 1,            // å½“å‰é¡µç 
            batchSize: 100,            // æ‰¹å¤„ç†å¤§å°
            lazyLoadImages: true,      // æ˜¯å¦å»¶è¿ŸåŠ è½½å›¾ç‰‡(å¦‚æœæœ‰)
            autoReleaseMemory: true,   // æ˜¯å¦è‡ªåŠ¨é‡Šæ”¾å†…å­˜
            
            // æ ¹æ®æ•°æ®è§„æ¨¡è‡ªåŠ¨è°ƒæ•´è®¾ç½®
            adjustForDataSize() {
                if (items.length > 1000) {
                    this.usePagination = true;
                    this.pageSize = 200;
                    this.batchSize = 100;
                    perfMonitor.enable(); // å¯ç”¨æ€§èƒ½ç›‘æ§
                } else if (items.length > 500) {
                    this.usePagination = false;
                    this.batchSize = 100;
                    perfMonitor.disable(); // åœç”¨æ€§èƒ½ç›‘æ§
                } else {
                    this.usePagination = false;
                    this.batchSize = items.length;
                    perfMonitor.disable(); // åœç”¨æ€§èƒ½ç›‘æ§
                }
            }
        };
        
        // åˆå§‹åŒ–æ—¶æ‰§è¡Œ
        perfMonitor.init();
        
        // æ·»åŠ å›åˆ°åº•éƒ¨æŒ‰é’®
        addScrollBottomButton();

        // åœ¨é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œçš„åˆå§‹åŒ–å‡½æ•°
        window.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–åº”ç”¨');
            
            // åˆå§‹åŒ–æ•°æ®åº“
            initDB();
            
            // æ·»åŠ è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
            itemInput.addEventListener('input', (e) => {
                showSuggestions(e.target.value);
            });
            
            // æ·»åŠ é”®ç›˜äº‹ä»¶
            itemInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const newItem = itemInput.value.trim();
                    if (newItem) {
                        addNewItem();
                    }
                }
            });
            
            // å…¶ä»–æŒ‰é’®åˆå§‹åŒ–
            exportButton.addEventListener('click', exportToTxt);
            batchAddButton.addEventListener('click', () => {
                importModal.style.display = 'block';
                overlay.style.display = 'block';
                importInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            });
        });

        // æ·»åŠ æ£€æŸ¥æ•°æ®æ˜¾ç¤ºçš„å‡½æ•°ï¼Œä¿®å¤å¯èƒ½çš„é—®é¢˜
        function checkAndRepairDisplay() {
            console.log('æ£€æŸ¥æ•°æ®æ˜¾ç¤ºçŠ¶æ€...');
            
            // å¦‚æœåˆ—è¡¨ä¸ºç©ºä½†æœ‰æ•°æ®ï¼Œé‡æ–°æ¸²æŸ“
            if (dataList.children.length === 0 && items.length > 0) {
                console.log('æ£€æµ‹åˆ°æ•°æ®æœªæ˜¾ç¤ºï¼Œé‡æ–°æ¸²æŸ“');
                renderSimpleList();
                return true;
            }
            
            // æ£€æŸ¥æŠ˜å çŠ¶æ€æ˜¯å¦ä¸€è‡´
            const locationItems = document.querySelectorAll('.location-item');
            locationItems.forEach(item => {
                const locationIndex = item.getAttribute('data-location-index');
                const assets = document.querySelectorAll(`[data-belongs-to="${locationIndex}"]`);
                const collapseIcon = item.querySelector('.collapse-icon');
                
                if (assets.length > 0) {
                    const isHidden = assets[0].style.display === 'none';
                    collapseIcon.textContent = isHidden ? 'â–¶' : 'â–¼';
                }
            });
            
            return false;
        }

        // ä¿®æ”¹æ˜¾ç¤ºé”™è¯¯æç¤ºçš„å‡½æ•°
        function showErrorToast(message) {
            console.error('é”™è¯¯:', message);
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(220, 53, 69, 0.9);
                color: white;
                padding: 10px 20px;
                border-radius: 4px;
                z-index: 1000;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s';
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 3000);
            
            // æ£€æŸ¥æ•°æ®æ˜¾ç¤º
            setTimeout(checkAndRepairDisplay, 1000);
        }

        // æ·»åŠ è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½
        function setupBackup() {
            // åŠ è½½å¤‡ä»½è®¾ç½®
            loadBackupSettings();
            
            // åŠ è½½å·²æœ‰å¤‡ä»½åˆ—è¡¨
            loadBackups();
            
            // è®¾ç½®è‡ªåŠ¨å¤‡ä»½å®šæ—¶å™¨
            setupBackupTimer();
            
            // æ·»åŠ å¤‡ä»½æŒ‰é’®åˆ°é¡µé¢
            addBackupButton();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬
            manualBackupButton.addEventListener('click', () => createBackup(false));
            restoreBackupButton.addEventListener('click', promptRestoreBackup);
            exportBackupButton.addEventListener('click', exportBackup);
            importBackupButton.addEventListener('click', () => backupFileInput.click());
            backupFileInput.addEventListener('change', importBackup);
            closeBackupModalButton.addEventListener('click', () => {
                backupModal.style.display = 'none';
                overlay.style.display = 'none';
            });
            
            // è®¾ç½®å˜æ›´ç›‘å¬
            autoBackupEnabledCheckbox.addEventListener('change', updateBackupSettings);
            backupFrequencySelect.addEventListener('change', updateBackupSettings);
            backupRetentionSelect.addEventListener('change', updateBackupSettings);
            
            console.log('å¤‡ä»½ç³»ç»Ÿå·²åˆå§‹åŒ–');
        }
        
        // æ·»åŠ å›åˆ°åº•éƒ¨æŒ‰é’®åˆ°ç•Œé¢
        function addScrollBottomButton() {
            const scrollBottomButton = document.createElement('button');
            scrollBottomButton.id = 'scrollBottomButton';
            scrollBottomButton.title = 'å›åˆ°åˆ—è¡¨åº•éƒ¨';
            scrollBottomButton.textContent = 'â†“';
            
            scrollBottomButton.addEventListener('mouseover', () => {
                scrollBottomButton.style.backgroundColor = 'rgba(40, 167, 69, 1)';
                scrollBottomButton.style.transform = 'translateY(-2px)';
                scrollBottomButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            });
            
            scrollBottomButton.addEventListener('mouseout', () => {
                scrollBottomButton.style.backgroundColor = 'rgba(40, 167, 69, 0.8)';
                scrollBottomButton.style.transform = '';
                scrollBottomButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            });
            
            scrollBottomButton.addEventListener('click', () => {
                scrollToBottom();
                showToast('å·²æ»šåŠ¨åˆ°åº•éƒ¨');
            });
            
            document.body.appendChild(scrollBottomButton);
        }
        
        // æ·»åŠ å¤‡ä»½æŒ‰é’®åˆ°ç•Œé¢
        function addBackupButton() {
            const backupButton = document.createElement('button');
            backupButton.id = 'backupButton';
            backupButton.title = 'æ•°æ®å¤‡ä»½ä¸æ¢å¤';
            backupButton.textContent = 'ğŸ’¾';
            backupButton.style.cssText = `
                position: fixed;
                left: 20px;
                bottom: 20px;
                width: 40px;
                height: 40px;
                background-color: rgba(0, 123, 255, 0.8);
                color: white;
                border: none;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 20px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
                z-index: 999;
            `;
            
            backupButton.addEventListener('mouseover', () => {
                backupButton.style.backgroundColor = 'rgba(0, 123, 255, 1)';
                backupButton.style.transform = 'translateY(-2px)';
                backupButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            });
            
            backupButton.addEventListener('mouseout', () => {
                backupButton.style.backgroundColor = 'rgba(0, 123, 255, 0.8)';
                backupButton.style.transform = '';
                backupButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            });
            
            backupButton.addEventListener('click', openBackupModal);
            
            document.body.appendChild(backupButton);
        }
        
        // æ‰“å¼€å¤‡ä»½æ¨¡æ€æ¡†
        function openBackupModal() {
            updateBackupsList();
            updateBackupUI();
            
            backupModal.style.display = 'block';
            overlay.style.display = 'block';
        }
        
        // æ›´æ–°å¤‡ä»½è®¾ç½®UI
        function updateBackupUI() {
            lastBackupTimeSpan.textContent = backupSettings.lastBackupTime 
                ? new Date(backupSettings.lastBackupTime).toLocaleString() 
                : 'æ— ';
                
            backupStatusSpan.textContent = backupSettings.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
            autoBackupEnabledCheckbox.checked = backupSettings.enabled;
            backupFrequencySelect.value = backupSettings.frequency.toString();
            backupRetentionSelect.value = backupSettings.retention.toString();
        }
        
        // åŠ è½½å¤‡ä»½è®¾ç½®
        function loadBackupSettings() {
            try {
                const savedSettings = localStorage.getItem('backupSettings');
                if (savedSettings) {
                    backupSettings = JSON.parse(savedSettings);
                    console.log('å·²åŠ è½½å¤‡ä»½è®¾ç½®:', backupSettings);
                }
            } catch (error) {
                console.error('åŠ è½½å¤‡ä»½è®¾ç½®å‡ºé”™:', error);
                // ä½¿ç”¨é»˜è®¤è®¾ç½®
                backupSettings = {
                    enabled: true,
                    frequency: 86400000,
                    retention: 3,
                    lastBackupTime: null
                };
            }
        }
        
        // ä¿å­˜å¤‡ä»½è®¾ç½®
        function saveBackupSettings() {
            try {
                localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
                console.log('å¤‡ä»½è®¾ç½®å·²ä¿å­˜');
            } catch (error) {
                console.error('ä¿å­˜å¤‡ä»½è®¾ç½®å‡ºé”™:', error);
                showErrorToast('ä¿å­˜å¤‡ä»½è®¾ç½®å¤±è´¥');
            }
        }
        
        // æ›´æ–°å¤‡ä»½è®¾ç½®
        function updateBackupSettings() {
            backupSettings.enabled = autoBackupEnabledCheckbox.checked;
            backupSettings.frequency = parseInt(backupFrequencySelect.value);
            backupSettings.retention = parseInt(backupRetentionSelect.value);
            
            saveBackupSettings();
            setupBackupTimer(); // é‡æ–°è®¾ç½®å®šæ—¶å™¨
            updateBackupUI(); // æ›´æ–°ç•Œé¢
            
            showToast('å¤‡ä»½è®¾ç½®å·²æ›´æ–°');
        }
        
        // è®¾ç½®å¤‡ä»½å®šæ—¶å™¨
        function setupBackupTimer() {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (backupTimer) {
                clearInterval(backupTimer);
                backupTimer = null;
            }
            
            // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨å¤‡ä»½
            if (backupSettings.enabled) {
                backupTimer = setInterval(() => {
                    console.log('æ‰§è¡Œè‡ªåŠ¨å¤‡ä»½...');
                    createBackup(true);
                }, backupSettings.frequency);
                
                console.log(`è‡ªåŠ¨å¤‡ä»½å·²è®¾ç½®ï¼Œé¢‘ç‡: ${backupSettings.frequency / (1000 * 60 * 60)} å°æ—¶`);
            } else {
                console.log('è‡ªåŠ¨å¤‡ä»½å·²ç¦ç”¨');
            }
        }
        
        // åˆ›å»ºå¤‡ä»½
        function createBackup(isAuto = false) {
            try {
                if (!db) {
                    showErrorToast('æ•°æ®åº“æœªå‡†å¤‡å¥½ï¼Œæ— æ³•å¤‡ä»½');
                    return;
                }
                
                const transaction = db.transaction(['items'], 'readonly');
                const store = transaction.objectStore('items');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const currentData = request.result;
                    
                    if (!currentData || currentData.length === 0) {
                        showErrorToast('æ²¡æœ‰æ•°æ®å¯å¤‡ä»½');
                        return;
                    }
                    
                    // åˆ›å»ºå¤‡ä»½å¯¹è±¡
                    const timestamp = new Date().getTime();
                    const backupName = `backup_${timestamp}`;
                    const backup = {
                        id: backupName,
                        timestamp: timestamp,
                        description: isAuto ? 'è‡ªåŠ¨å¤‡ä»½' : 'æ‰‹åŠ¨å¤‡ä»½',
                        data: currentData,
                        itemCount: currentData.length
                    };
                    
                    // ä¿å­˜å¤‡ä»½åˆ°localStorage
                    try {
                        localStorage.setItem(backupName, JSON.stringify(backup));
                        
                        // æ›´æ–°å¤‡ä»½åˆ—è¡¨
                        loadBackups();
                        
                        // æ›´æ–°æœ€åå¤‡ä»½æ—¶é—´
                        backupSettings.lastBackupTime = timestamp;
                        saveBackupSettings();
                        
                        // ç®¡ç†å¤‡ä»½æ•°é‡
                        manageBackups();
                        
                        console.log(`å¤‡ä»½åˆ›å»ºæˆåŠŸ: ${backupName}, åŒ…å« ${currentData.length} æ¡è®°å½•`);
                        
                        if (!isAuto) {
                            showToast('å¤‡ä»½åˆ›å»ºæˆåŠŸï¼');
                            updateBackupUI();
                            updateBackupsList();
                        }
                    } catch (error) {
                        console.error('ä¿å­˜å¤‡ä»½åˆ°localStorageå‡ºé”™:', error);
                        
                        // å¦‚æœlocalStorageç©ºé—´ä¸è¶³ï¼Œå°è¯•å¯¼å‡ºåˆ°æ–‡ä»¶
                        if (error.name === 'QuotaExceededError') {
                            showErrorToast('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•å¯¼å‡ºåˆ°æ–‡ä»¶');
                            exportBackupToFile(backup);
                        } else {
                            showErrorToast('åˆ›å»ºå¤‡ä»½å¤±è´¥: ' + error.message);
                        }
                    }
                };
                
                request.onerror = (event) => {
                    console.error('è·å–å¤‡ä»½æ•°æ®å‡ºé”™:', event.target.error);
                    showErrorToast('è·å–å¤‡ä»½æ•°æ®å¤±è´¥');
                };
            } catch (error) {
                console.error('åˆ›å»ºå¤‡ä»½æ—¶å‡ºé”™:', error);
                showErrorToast('åˆ›å»ºå¤‡ä»½å¤±è´¥');
            }
        }
        
        // å¯¼å‡ºå¤‡ä»½åˆ°æ–‡ä»¶
        function exportBackupToFile(backup) {
            try {
                const backupBlob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(backupBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `å¿«é€Ÿåº“å­˜æ¸…å•_å¤‡ä»½_${new Date(backup.timestamp).toLocaleString().replace(/[\/\s:]/g, '_')}.json`;
                document.body.appendChild(link);
                link.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showToast('å¤‡ä»½å·²å¯¼å‡ºåˆ°æ–‡ä»¶');
            } catch (error) {
                console.error('å¯¼å‡ºå¤‡ä»½åˆ°æ–‡ä»¶å‡ºé”™:', error);
                showErrorToast('å¯¼å‡ºå¤‡ä»½å¤±è´¥: ' + error.message);
            }
        }
        
        // ç®¡ç†å¤‡ä»½æ•°é‡
        function manageBackups() {
            try {
                // æŒ‰æ—¶é—´é™åºæ’åˆ—å¤‡ä»½
                backups.sort((a, b) => b.timestamp - a.timestamp);
                
                // å¦‚æœè¶…è¿‡ä¿ç•™æ•°é‡ï¼Œåˆ é™¤æ—§å¤‡ä»½
                if (backups.length > backupSettings.retention) {
                    console.log(`å¤‡ä»½æ•°é‡(${backups.length})è¶…è¿‡ä¿ç•™é™åˆ¶(${backupSettings.retention})ï¼Œåˆ é™¤æ—§å¤‡ä»½`);
                    
                    const backupsToRemove = backups.slice(backupSettings.retention);
                    backupsToRemove.forEach(backup => {
                        try {
                            localStorage.removeItem(backup.id);
                            console.log(`å·²åˆ é™¤æ—§å¤‡ä»½: ${backup.id}`);
                        } catch (error) {
                            console.error(`åˆ é™¤å¤‡ä»½ ${backup.id} å‡ºé”™:`, error);
                        }
                    });
                    
                    // æ›´æ–°å¤‡ä»½åˆ—è¡¨
                    loadBackups();
                }
            } catch (error) {
                console.error('ç®¡ç†å¤‡ä»½æ•°é‡å‡ºé”™:', error);
            }
        }
        
        // åŠ è½½æ‰€æœ‰å¤‡ä»½
        function loadBackups() {
            try {
                backups = [];
                
                // æŸ¥æ‰¾localStorageä¸­çš„æ‰€æœ‰å¤‡ä»½
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    if (key.startsWith('backup_')) {
                        try {
                            const backup = JSON.parse(localStorage.getItem(key));
                            backups.push(backup);
                        } catch (error) {
                            console.error(`è§£æå¤‡ä»½ ${key} å‡ºé”™:`, error);
                        }
                    }
                }
                
                // æŒ‰æ—¶é—´é™åºæ’åˆ—
                backups.sort((a, b) => b.timestamp - a.timestamp);
                console.log(`å·²åŠ è½½ ${backups.length} ä¸ªå¤‡ä»½`);
                
                return backups;
            } catch (error) {
                console.error('åŠ è½½å¤‡ä»½åˆ—è¡¨å‡ºé”™:', error);
                return [];
            }
        }
        
        // æ›´æ–°å¤‡ä»½åˆ—è¡¨UI
        function updateBackupsList() {
            try {
                backupsList.innerHTML = '';
                
                if (backups.length === 0) {
                    backupsList.innerHTML = '<div class="no-backup">æš‚æ— å¤‡ä»½</div>';
                    return;
                }
                
                // åˆ›å»ºå¤‡ä»½åˆ—è¡¨
                backups.forEach(backup => {
                    const backupItem = document.createElement('div');
                    backupItem.className = 'backup-item';
                    
                    const dateStr = new Date(backup.timestamp).toLocaleString();
                    const itemCount = backup.itemCount || 'æœªçŸ¥';
                    
                    backupItem.innerHTML = `
                        <div class="backup-item-info">
                            <div class="backup-item-time">${dateStr}</div>
                            <div class="backup-item-desc">${backup.description}</div>
                            <div class="backup-item-count">é¡¹ç›®æ•°: ${itemCount}</div>
                        </div>
                        <div class="backup-item-actions">
                            <button class="backup-restore-btn" data-id="${backup.id}">æ¢å¤</button>
                            <button class="backup-export-btn" data-id="${backup.id}">å¯¼å‡º</button>
                            <button class="backup-delete-btn" data-id="${backup.id}">åˆ é™¤</button>
                        </div>
                    `;
                    
                    backupsList.appendChild(backupItem);
                });
                
                // æ·»åŠ å¤‡ä»½æ“ä½œäº‹ä»¶
                document.querySelectorAll('.backup-restore-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const backupId = e.target.getAttribute('data-id');
                        restoreBackup(backupId);
                    });
                });
                
                document.querySelectorAll('.backup-export-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const backupId = e.target.getAttribute('data-id');
                        const backup = backups.find(b => b.id === backupId);
                        if (backup) {
                            exportBackupToFile(backup);
                        }
                    });
                });
                
                document.querySelectorAll('.backup-delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const backupId = e.target.getAttribute('data-id');
                        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¤‡ä»½å—ï¼Ÿ')) {
                            deleteBackup(backupId);
                        }
                    });
                });
            } catch (error) {
                console.error('æ›´æ–°å¤‡ä»½åˆ—è¡¨UIå‡ºé”™:', error);
                backupsList.innerHTML = '<div class="backup-error">åŠ è½½å¤‡ä»½åˆ—è¡¨å‡ºé”™</div>';
            }
        }
        
        // æç¤ºæ¢å¤å¤‡ä»½
        function promptRestoreBackup() {
            if (backups.length === 0) {
                showErrorToast('æ²¡æœ‰å¯ç”¨çš„å¤‡ä»½');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¢å¤å¤‡ä»½å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«æ›¿æ¢ã€‚')) {
                // é»˜è®¤æ¢å¤æœ€æ–°çš„å¤‡ä»½
                restoreBackup(backups[0].id);
            }
        }
        
        // æ¢å¤å¤‡ä»½
        function restoreBackup(backupId) {
            try {
                const backupJson = localStorage.getItem(backupId);
                
                if (!backupJson) {
                    showErrorToast('æ‰¾ä¸åˆ°æŒ‡å®šçš„å¤‡ä»½');
                    return;
                }
                
                const backup = JSON.parse(backupJson);
                
                if (!backup.data || backup.data.length === 0) {
                    showErrorToast('å¤‡ä»½æ•°æ®ä¸ºç©ºæˆ–æ— æ•ˆ');
                    return;
                }
                
                // ç¡®è®¤å¯¹è¯æ¡† - å…ˆç¡®è®¤ï¼Œå†æ˜¾ç¤ºå¤„ç†ä¸­æç¤º
                if (!confirm(`ç¡®å®šè¦ä»"${new Date(backup.timestamp).toLocaleString()}"çš„å¤‡ä»½æ¢å¤${backup.data.length}æ¡æ•°æ®å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«æ›¿æ¢ã€‚`)) {
                    return;
                }
                
                // æ˜¾ç¤ºå¤„ç†ä¸­æç¤º
                showToast('æ­£åœ¨æ¢å¤æ•°æ®...');
                
                // ä½¿ç”¨setTimeoutç»™UIæ›´æ–°çš„æ—¶é—´
                setTimeout(() => {
                    try {
                        // æ¸…ç©ºå½“å‰æ•°æ®å¹¶æ¢å¤å¤‡ä»½
                        const transaction = db.transaction(['items'], 'readwrite');
                        const store = transaction.objectStore('items');
                        
                        // æ·»åŠ é”™è¯¯å¤„ç†
                        transaction.onerror = (event) => {
                            console.error('æ¢å¤å¤‡ä»½äº‹åŠ¡é”™è¯¯:', event.target.error);
                            showErrorToast('æ¢å¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š' + event.target.error.message);
                        };
                        
                        // æ¸…é™¤ç°æœ‰æ•°æ®
                        const clearRequest = store.clear();
                        
                        clearRequest.onerror = (event) => {
                            console.error('æ¸…é™¤æ•°æ®é”™è¯¯:', event.target.error);
                            showErrorToast('æ¸…é™¤ç°æœ‰æ•°æ®å¤±è´¥ï¼š' + event.target.error.message);
                            return;
                        };
                        
                        clearRequest.onsuccess = () => {
                            let addedCount = 0;
                            let errorCount = 0;
                            const batchSize = 50; // å¢å¤§æ‰¹æ¬¡å¤§å°æé«˜æ€§èƒ½
                            
                            // åˆ†æ‰¹æ·»åŠ æ•°æ® - æ”¹ç”¨è¿­ä»£æ–¹å¼è€Œéé€’å½’ï¼Œé¿å…è°ƒç”¨æ ˆæº¢å‡º
                            function processBatch(startIndex) {
                                let endIndex = Math.min(startIndex + batchSize, backup.data.length);
                                console.log(`å¤„ç†å¤‡ä»½æ•°æ®æ‰¹æ¬¡ ${startIndex} - ${endIndex}`);
                                
                                for (let i = startIndex; i < endIndex; i++) {
                                    const item = backup.data[i];
                                    try {
                                        const request = store.add(item);
                                        request.onsuccess = () => { addedCount++; };
                                        request.onerror = (event) => {
                                            console.error(`æ·»åŠ æ•°æ®é¡¹ ${i} å¤±è´¥:`, event.target.error);
                                            errorCount++;
                                        };
                                    } catch (err) {
                                        console.error(`å¤„ç†æ•°æ®é¡¹ ${i} å‡ºé”™:`, err);
                                        errorCount++;
                                    }
                                }
                                
                                // å¤„ç†ä¸‹ä¸€æ‰¹æ•°æ®
                                if (endIndex < backup.data.length) {
                                    // ä½¿ç”¨setTimeoutè®©æµè§ˆå™¨æœ‰æ—¶é—´æ›´æ–°UI
                                    setTimeout(() => processBatch(endIndex), 10);
                                }
                            }
                            
                            // å¼€å§‹å¤„ç†ç¬¬ä¸€æ‰¹
                            processBatch(0);
                            
                            transaction.oncomplete = () => {
                                console.log(`å¤‡ä»½æ¢å¤å®Œæˆ: æ·»åŠ  ${addedCount} é¡¹ï¼Œå¤±è´¥ ${errorCount} é¡¹`);
                                
                                // å…³é—­å¤‡ä»½æ¨¡æ€æ¡†
                                backupModal.style.display = 'none';
                                overlay.style.display = 'none';
                                
                                // é‡æ–°åŠ è½½æ•°æ®
                                loadItems();
                                showToast(`å¤‡ä»½æ¢å¤æˆåŠŸï¼Œå…±æ¢å¤ ${addedCount} æ¡æ•°æ®ï¼`);
                            };
                        };
                    } catch (innerError) {
                        console.error('æ¢å¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', innerError);
                        showErrorToast('æ¢å¤å¤±è´¥: ' + innerError.message);
                    }
                }, 100); // ç»™UIæ—¶é—´æ˜¾ç¤ºå¤„ç†ä¸­çš„æç¤º
                
            } catch (error) {
                console.error('æ¢å¤å¤‡ä»½å‡ºé”™:', error);
                showErrorToast('æ¢å¤å¤‡ä»½å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤å¤‡ä»½
        function deleteBackup(backupId) {
            try {
                localStorage.removeItem(backupId);
                console.log(`å¤‡ä»½ ${backupId} å·²åˆ é™¤`);
                
                // æ›´æ–°å¤‡ä»½åˆ—è¡¨
                loadBackups();
                updateBackupsList();
                showToast('å¤‡ä»½å·²åˆ é™¤');
            } catch (error) {
                console.error('åˆ é™¤å¤‡ä»½å‡ºé”™:', error);
                showErrorToast('åˆ é™¤å¤‡ä»½å¤±è´¥: ' + error.message);
            }
        }
        
        // å¯¼å‡ºå½“å‰å¤‡ä»½
        function exportBackup() {
            // å…ˆåˆ›å»ºä¸€ä¸ªå¤‡ä»½ï¼Œç„¶åå¯¼å‡º
            try {
                const transaction = db.transaction(['items'], 'readonly');
                const store = transaction.objectStore('items');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const currentData = request.result;
                    
                    if (!currentData || currentData.length === 0) {
                        showErrorToast('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                        return;
                    }
                    
                    // åˆ›å»ºå¤‡ä»½å¯¹è±¡
                    const timestamp = new Date().getTime();
                    const backup = {
                        id: `export_${timestamp}`,
                        timestamp: timestamp,
                        description: 'æ‰‹åŠ¨å¯¼å‡º',
                        data: currentData,
                        itemCount: currentData.length
                    };
                    
                    exportBackupToFile(backup);
                };
            } catch (error) {
                console.error('å¯¼å‡ºå¤‡ä»½å‡ºé”™:', error);
                showErrorToast('å¯¼å‡ºå¤‡ä»½å¤±è´¥: ' + error.message);
            }
        }
        
        // å¯¼å…¥å¤‡ä»½
        function importBackup(e) {
            try {
                const file = e.target.files[0];
                if (!file) {
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        if (!backup.data || !backup.timestamp) {
                            showErrorToast('å¤‡ä»½æ–‡ä»¶æ ¼å¼æ— æ•ˆ');
                            return;
                        }
                        
                        // å¯¼å…¥å¤‡ä»½åˆ°localStorage
                        const backupId = `backup_${new Date().getTime()}`; // ä½¿ç”¨æ–°çš„IDé¿å…å†²çª
                        backup.id = backupId;
                        backup.description = 'ä»æ–‡ä»¶å¯¼å…¥';
                        
                        localStorage.setItem(backupId, JSON.stringify(backup));
                        
                        // æ›´æ–°å¤‡ä»½åˆ—è¡¨
                        loadBackups();
                        updateBackupsList();
                        showToast('å¤‡ä»½å·²å¯¼å…¥');
                    } catch (error) {
                        console.error('è§£æå¤‡ä»½æ–‡ä»¶å‡ºé”™:', error);
                        showErrorToast('å¤‡ä»½æ–‡ä»¶æ ¼å¼é”™è¯¯');
                    }
                };
                
                reader.onerror = () => {
                    showErrorToast('è¯»å–å¤‡ä»½æ–‡ä»¶å¤±è´¥');
                };
                
                reader.readAsText(file);
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼Œå…è®¸é€‰æ‹©åŒä¸€æ–‡ä»¶
                e.target.value = '';
            } catch (error) {
                console.error('å¯¼å…¥å¤‡ä»½å‡ºé”™:', error);
                showErrorToast('å¯¼å…¥å¤‡ä»½å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
